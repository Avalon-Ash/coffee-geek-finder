<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>咖啡器材管理器</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        /* CSS Styles (Skipped for brevity) */
        body { background-color: #0c0c0c; color: #e5e5e5; font-family: system-ui, -apple-system, sans-serif; overflow-x: hidden; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0c0c0c; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .tetris-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            grid-auto-rows: auto; 
            grid-auto-flow: dense; 
            gap: 1.5rem; 
        }

        /* Markdown Styles */
        .mkd h1, .mkd h2, .mkd h3 { color: #facc15; font-weight: 700; margin-top: 1em; margin-bottom: 0.5em; border-bottom: 1px solid #333; padding-bottom: 0.3em; }
        .mkd ul { list-style: disc; padding-left: 1.5em; color: #a8a29e; margin-bottom: 1em; }
        .mkd table { border-collapse: collapse; width: 100%; margin: 1em 0; font-size: 0.9em; }
        .mkd th, .mkd td { border: 1px solid #444; padding: 0.5em; text-align: left; }
        .mkd th { background-color: #222; color: #facc15; }
        
        /* Modal Fix: Fixed positioning for max stability */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9000;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- 1. Configuration & Constants ---
        const CONFIG_FILE = "./project_config.json"; 
        const API_MODEL = "gemini-2.5-flash-preview-09-2025";
        const LS_KEY_PREFIX = "CGF_DB_"; 
        
        // --- EMBEDDED CONFIGURATION (Source of truth for UI/Logic) ---
        const EMBEDDED_CONFIG = {
            "project": { "title": "咖啡狂器具搜尋器", "version": "v51.0", "item_name_tw": "咖啡器材" },
            "ui_labels": {
                "header_title": "COFFEE GEEK", "search_placeholder": "搜尋器材 / 讓 AI 擴充...", "capacity_label": "容量/尺寸",
                "feature_label_map": { "磨": "刀盤/機制", "壺": "壺嘴/控溫", "濾": "結構/流速", "秤": "反應/特性", "壓": "壓力機制" }
            },
            "ai_prompts": {
                "search_system": "你是一位頂尖的咖啡器材數據生成師。", "search_prompt_schema": "Schema: {\"brand\":\"String (TW)\",\"model\":\"String (TW)\",\"type\":\"String (TW)\",\"material\":\"String (TW)\",\"capacity\":\"String (TW)\",\"feature\":\"String (TW)\",\"priceLevel\":\"String ($$$)\",\"verdict\":\"String (TW)\",\"pros\":[\"String (TW)\"],\"cons\":[\"String (TW)\"],\"sentiment\":[{\"name\":\"Tag (TW)\",\"value\":Number,\"color\":\"String (#hex)\"}]}. Return ONLY JSON.",
                "review_title": "AI 毒舌評論", "review_prompt_system": "你是一位極度毒舌且專業的咖啡器材評論家，請使用 Markdown 格式，並且必須使用繁體中文。",
                "recipe_title": "AI 沖煮建議", "recipe_prompt_system": "你是一位頂尖的咖啡師，請提供一份適合「中焙」豆子的具體沖煮參數，使用 Markdown 表格來呈現參數，所有文字必須是繁體中文。"
            },
            "db_config": { "manifest_file": "./db_manifest.json" }
        };

        // --- 2. Logic Layer (IO & Utilities) ---
        const IO = {
            get: (k) => { try { return localStorage.getItem(k); } catch { return null; } },
            set: (k, v) => { try { return localStorage.setItem(k, v); } catch { return false; } },
            del: (k) => { try { localStorage.removeItem(k); } catch {} },
            
            genId: (list) => (Array.isArray(list) ? list.reduce((max, item) => Math.max(max, Number(item.id) || 0), 0) : 0) + 1,

            enrich: (raw) => {
                if (!raw || typeof raw !== 'object') return null;
                const p = { ...raw };
                p.id = p.id || Date.now() + Math.random();
                p.pros = Array.isArray(p.pros) ? p.pros : [];
                p.cons = Array.isArray(p.cons) ? p.cons : [];
                p.sentiment = Array.isArray(p.sentiment) ? p.sentiment : [{ name: "N/A", value: 100, color: "#94a3b8" }];
                return p;
            },

            parseJSON: (text) => {
                if (!text) return null;
                try {
                    const clean = text.replace(/```json|```/g, '').trim();
                    const start = clean.indexOf('[');
                    const end = clean.lastIndexOf(']');
                    if (start !== -1 && end !== -1) { return JSON.parse(clean.substring(start, end + 1)); }
                    return JSON.parse(clean);
                } catch (e) {
                    return null;
                }
            },

            proxyUrl: (url) => {
                const driveRegex = /\/file\/d\/([a-zA-Z0-9_-]+)\//;
                const match = url.match(driveRegex);
                if (match && match[1]) {
                    return `https://api.allorigins.win/raw?url=${encodeURIComponent(`https://drive.google.com/uc?export=download&id=${match[1]}`)}`;
                }
                return url;
            },
            
            getSpanClass: (item) => {
                let score = 0;
                const len = (item.verdict || "").length;
                if ((item.pros || []).length + (item.cons || []).length >= 5) score += 2;
                if (item.priceLevel === "$$$$$" || item.priceLevel === "$$$$") score += 2;
                if (len > 30) score += 1;
                const hash = (parseInt(item.id) || 0) % 3;
                
                if (score >= 4) return "col-span-1 md:col-span-2 row-span-2"; 
                if (score === 3) return hash === 0 ? "col-span-1 md:col-span-2 row-span-1" : "col-span-1 row-span-2";
                return "col-span-1 row-span-1";
            },

            getFeatureLabel: (type, config) => {
                const map = config?.ui_labels?.feature_label_map;
                if (!map) return "特點";
                for (const key in map) {
                    if ((type || "").toLowerCase().includes(key)) return map[key];
                }
                return "特點";
            }
        };

        // --- 3. Pure JS Components (Simplified for execution speed) ---
        const Ico = ({ n, c = "w-4 h-4" }) => {
            const paths = {
                search: "m21 21-4.3-4.3M11 19a8 8 0 1 0 0-16 8 8 0 0 0 0 16z", cloud: "M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242",
                upload: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12", settings: "M12.22 2h-.44a2 2 0 0 1-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l-.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l-.43-.25a2 2 0 0 1 2 0l-.15.08a2 2 0 C94-39-38-65-8-6-86-53-73-8-9z M12 9a3 3 0 1 0 0 6 3 3 0 0 0 0-6z",
                plus: "M12 5v14M5 12h14", trash: "M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",
                download: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3", msg: "M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z",
                chef: "M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 9.08 0A5.11 5.11 0 0 1 18.59 6 4 4 0 0 1 20 13.87V21H6Z M6 17h14",
                scale: "M6 20h12a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2z M12 14v4 M12 2v4",
                tag: "M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z M7 7h.01",
                image: "M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z M12 17a4 4 0 1 0 0-8 4 4 0 0 0 0 8z",
                up: "M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3",
                down: "M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2h-3",
                refresh: "M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16",
                close: "M18 6 6 18 M6 6 18 18"
            };
            return React.createElement('svg', { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: c }, React.createElement('path', { d: paths[n] || "" }));
        };

        const PieChart = React.memo(({ data }) => { 
            if(!data || !data.length) return null;
            const total = data.reduce((s, i) => s + (i.value || 0), 0);
            const items = data.map(i => ({...i, percent: (i.value || 0) / total}));
            let cumulativePercent = 0;
            const getCoords = (pct) => [Math.cos(2*Math.PI*pct), Math.sin(2*Math.PI*pct)];
            
            const paths = items.map((slice, i) => {
                const start = cumulativePercent;
                const end = start + slice.percent;
                cumulativePercent = end;
                const [sx, sy] = getCoords(start);
                const [ex, ey] = getCoords(end);
                const large = slice.percent > 0.5 ? 1 : 0;
                const d = `M ${sx} ${sy} A 1 1 0 ${large} 1 ${ex} ${ey} L ${ex*0.65} ${ey*0.65} A 0.65 0.65 0 ${large} 0 ${sx*0.65} ${sy*0.65} Z`;
                
                return React.createElement('path', { key: i, d: d, fill: slice.color, stroke: "#18181b", strokeWidth: "0.02", className: "hover:opacity-80 transition-opacity" },
                    React.createElement('title', null, `${slice.name}: ${Math.round(slice.percent * 100)}%`)
                );
            });

            return React.createElement('svg', { viewBox: "-1.1 -1.1 2.2 2.2", className: "w-full h-full -rotate-90" }, paths);
        });

        // Card Component
        const Card = React.memo(function Card({ item, spanClass, onAI, config }) {
            if (!item) return null;

            const isHuge = spanClass.includes('row-span-2') && spanClass.includes('col-span-2');
            const isBig = spanClass.includes('row-span-2') || spanClass.includes('col-span-2');
            
            const typo = {
                brand: isHuge ? "text-lg font-black tracking-[0.2em]" : "text-xs font-bold tracking-widest",
                title: isHuge ? "text-5xl md:text-6xl mt-2 mb-4" : (isBig ? "text-3xl mt-1 mb-2" : "text-xl"),
                verdict: isHuge ? "text-base" : (isBig ? "text-base" : "text-sm"),
                listText: isHuge ? "text-base" : "text-xs", 
                btn: isHuge ? "text-sm py-2.5" : "text-xs py-2",
                featLabel: isHuge ? "text-sm" : "text-xs",
                feat: isHuge ? "text-lg" : "text-sm"
            };

            const searchUrl = (type) => {
                const q = encodeURIComponent(`${item.brand || ''} ${item.model || ''}`);
                return type === 'shopee' ? `https://shopee.tw/search?keyword=${q}` : `https://www.momoshop.com.tw/search/searchShop.jsp?keyword=${q}`;
            };

            const handleImageSearch = () => {
                const q = encodeURIComponent(`${item.brand || ''} ${item.model || ''} ${item.type || ''}`);
                window.open(`https://www.google.com/search?tbm=isch&q=${q}`, '_blank');
            };

            const handleRecipeClick = () => {
                onAI('recipe', item);
            };

            const renderIcon = (n, c) => React.createElement(Ico, { n: n, c: c });
            const renderLink = (url, label, color) => React.createElement('a', { href: url, target: "_blank", className: `flex items-center justify-center gap-1 ${color} text-white font-bold rounded hover:opacity-90 transition ${typo.btn}` }, label);
            const renderList = (arr, color) => React.createElement('ul', { className: `space-y-1 text-gray-400 ${typo.listText}` }, arr.slice(0, isHuge ? 8 : 3).map((p, i) => React.createElement('li', { key: i, className: 'flex items-start' }, React.createElement('span', { className: `mr-1.5 ${color}` }, '•'), React.createElement('span', { className: 'truncate' }, p))));

            return React.createElement('div', { className: `bg-[#18181b] border border-[#27272a] rounded-xl p-5 flex flex-col gap-3 hover:border-yellow-600/50 hover:shadow-2xl transition-all duration-300 relative h-full group ${spanClass}` },
                // Header
                React.createElement('div', { className: 'flex justify-between items-start' },
                    React.createElement('div', { className: 'min-w-0 pr-2 flex-1' },
                        React.createElement('span', { className: `text-yellow-500 uppercase block truncate ${typo.brand}` }, item.brand),
                        React.createElement('h3', { className: `font-bold text-gray-100 leading-none truncate ${typo.title}` }, item.model),
                        React.createElement('div', { className: 'flex gap-2 mt-2' },
                            React.createElement('span', { className: 'flex items-center gap-1 bg-[#27272a] text-gray-400 px-2 py-1 rounded border border-[#3f3f46] text-xs' }, renderIcon('tag', 'w-3 h-3'), item.type),
                            React.createElement('span', { className: 'flex items-center gap-1 bg-[#27272a] text-gray-400 px-2 py-1 rounded border border-[#3f3f46] text-xs' }, renderIcon('scale', 'w-3 h-3'), item.capacity)
                        )
                    ),
                    React.createElement('button', { onClick: handleImageSearch, className: 'flex items-center gap-1 bg-[#27272a] hover:bg-[#3f3f46] text-gray-400 hover:text-white px-2 py-1.5 rounded border border-[#3f3f46] transition-colors flex-shrink-0', title: 'Image Search' }, renderIcon('image', 'w-4 h-4'), isBig ? React.createElement('span', { className: 'text-xs ml-1' }, 'Image') : null)
                ),
                // Verdict
                React.createElement('div', { className: 'bg-[#27272a]/50 p-3 rounded border-l-4 border-yellow-600 flex flex-col gap-1' },
                    React.createElement('div', { className: 'flex justify-between items-center text-xs font-bold tracking-wider text-gray-500 mb-1' }, React.createElement('span', null, 'GEEK VERDICT'), React.createElement('span', { className: 'text-yellow-500 font-mono text-base' }, item.priceLevel)),
                    React.createElement('p', { className: `text-gray-300 italic leading-relaxed ${typo.verdict}` }, `"${item.verdict}"`)
                ),
                // Pros/Cons
                React.createElement('div', { className: `grid grid-cols-2 gap-4 flex-grow ${isBig ? 'overflow-auto' : 'overflow-hidden'}` },
                    React.createElement('div', null,
                        React.createElement('span', { className: `text-emerald-500 font-bold block tracking-wide flex items-center gap-1 mb-1 ${typo.listText}` }, renderIcon('up', 'w-3 h-3'), 'PROS'),
                        renderList(item.pros, 'text-emerald-500/50')
                    ),
                    React.createElement('div', null,
                        React.createElement('span', { className: `text-rose-500 font-bold block tracking-wide flex items-center gap-1 mb-1 ${typo.listText}` }, renderIcon('down', 'w-3 h-3'), 'CONS'),
                        renderList(item.cons, 'text-rose-500/50')
                    )
                ),
                // Footer
                React.createElement('div', { className: 'flex items-center justify-between border-t border-[#27272a] pt-3 mt-auto' },
                    React.createElement('div', { className: `${isHuge ? 'w-16 h-16' : 'w-12 h-12'} relative flex-shrink-0 mr-4` }, React.createElement(PieChart, { data: item.sentiment })),
                    React.createElement('div', { className: 'flex flex-col items-end' },
                        React.createElement('span', { className: `text-gray-500 uppercase font-bold ${typo.featLabel}` }, IO.getFeatureLabel(item.type, config)),
                        React.createElement('span', { className: `text-gray-200 font-mono border border-[#3f3f46] bg-[#27272a] px-2 py-0.5 rounded ${typo.feat}` }, item.feature || "N/A")
                    )
                ),
                // Buttons
                React.createElement('div', { className: 'grid grid-cols-2 gap-2 mt-2' },
                    React.createElement('button', { onClick: () => onAI('snark', item), className: `flex items-center justify-center gap-1 bg-indigo-900/20 text-indigo-300 border border-indigo-500/30 rounded hover:bg-indigo-900/40 transition ${typo.btn}` }, renderIcon('msg', 'w-3 h-3'), isHuge ? 'AI 毒舌評論' : 'Review'),
                    React.createElement('div', { className: 'relative' },
                        React.createElement('button', { onClick: handleRecipeClick, className: `w-full flex items-center justify-center gap-1 bg-emerald-900/20 text-emerald-300 border border-emerald-500/30 rounded hover:bg-emerald-900/40 transition ${typo.btn}` }, renderIcon('chef', 'w-3 h-3'), isHuge ? 'AI 沖煮建議' : 'Recipe'),
                    ),
                    renderLink(searchUrl('shopee'), 'Shopee', 'bg-[#ee4d2d]'),
                    renderLink(searchUrl('momo'), 'MOMO', 'bg-[#d63086]')
                )
            );
        });

        // Modal Component
        const Modal = (function ModalComponent() {
            return function Modal({ modalState, setModalState, onAddFromSearch, config }) {
                if (!modalState.open) return null;

                const handleClose = () => setModalState({ open: false, loading: false, content: "", title: "", type: "", error: "", results: [] });
                
                const handleAdd = (item) => {
                    onAddFromSearch(item);
                    if (modalState.results.length <= 1) handleClose();
                };

                const isSearch = modalState.type === 'search-results';

                const renderHeader = () => React.createElement('div', { className: 'p-4 border-b border-[#27272a] bg-[#0c0c0c] flex justify-between items-center shrink-0' },
                    React.createElement('h3', { className: 'font-bold text-yellow-500 flex items-center gap-2' },
                        React.createElement(Ico, { n: modalState.loading ? "refresh" : (isSearch ? "search" : "msg"), c: `w-5 h-5 ${modalState.loading ? "spin" : ""}` }),
                        modalState.title
                    ),
                    React.createElement('button', { onClick: handleClose, disabled: modalState.loading, className: 'text-gray-500 hover:text-white text-xl' }, React.createElement(Ico, { n: "close", c: "w-5 h-5" }))
                );

                const renderLoading = () => React.createElement('div', { className: 'flex flex-col items-center py-10' }, React.createElement('div', { className: 'w-10 h-10 border-2 border-yellow-600 border-t-transparent rounded-full spin' }));
                const renderError = () => React.createElement('p', { className: 'text-red-400 text-center col-span-full' }, modalState.error);
                
                const renderSearchContent = () => modalState.results.map(item => 
                    React.createElement('div', { key: item.id, className: 'bg-[#1f1f22] border border-[#27272a] rounded-lg p-4 flex flex-col gap-2 hover:border-yellow-600/50' },
                        React.createElement('div', { className: 'flex justify-between' }, React.createElement('span', { className: 'text-xs text-yellow-500 font-bold' }, item.brand), React.createElement('span', { className: 'text-xs text-gray-400' }, item.type)),
                        React.createElement('h4', { className: 'text-base font-bold text-white' }, item.model),
                        React.createElement('p', { className: 'text-sm text-gray-400 italic line-clamp-2' }, `"${item.verdict}"`),
                        React.createElement('button', { 
                            onClick: () => handleAdd(item), 
                            className: 'mt-auto w-full py-2 bg-emerald-900/30 text-emerald-400 border border-emerald-800 rounded hover:bg-emerald-900/50 text-sm flex items-center justify-center gap-2'
                        }, React.createElement(Ico, { n: "plus", c: "w-3 h-3" }), ' 加入資料庫')
                    )
                );

                const renderDefaultContent = () => React.createElement('div', { className: 'mkd text-gray-300', dangerouslySetInnerHTML: { __html: marked.parse(modalState.content || "") } });
                
                const contentClasses = `p-6 overflow-y-auto ${isSearch ? 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 bg-[#0c0c0c]' : 'bg-[#0c0c0c]'}`;
                
                let content;
                if (modalState.loading) { content = renderLoading(); } 
                else if (modalState.error) { content = renderError(); } 
                else if (isSearch) { content = renderSearchContent(); } 
                else { content = renderDefaultContent(); }
                
                return React.createElement('div', { className: 'modal-overlay', onClick: handleClose },
                    React.createElement('div', { 
                        className: `bg-[#18181b] border border-[#27272a] rounded-xl shadow-2xl overflow-hidden flex flex-col ${isSearch ? 'w-full max-w-5xl max-h-[90vh]' : 'w-full max-w-2xl max-h-[80vh]'}`, 
                        onClick: e => e.stopPropagation() 
                    },
                        renderHeader(),
                        React.createElement('div', { className: contentClasses }, content)
                    )
                );
            };
        })();
        
        // WelcomeScreen, CloudImportModal, ApiKeyModal components (Skipped for brevity)
        const WelcomeScreen = (function WelcomeScreenComponent() {
            return function WelcomeScreen({ onFileImport, onCloudClick, config }) {
                const renderIco = (n, c) => React.createElement(Ico, {n, c});
                
                const FileInput = (
                    React.createElement('label', { className: 'group cursor-pointer bg-[#18181b] border border-[#27272a] p-8 rounded-2xl hover:border-yellow-600/50 hover:bg-[#1f1f22] transition-all duration-300 flex flex-col items-center gap-4 shadow-lg' },
                        React.createElement('div', { className: 'p-4 bg-[#27272a] rounded-full group-hover:bg-yellow-900/20 transition-colors' }, renderIco('upload', 'w-8 h-8 text-yellow-500')),
                        React.createElement('div', null, 
                            React.createElement('h3', { className: 'text-xl font-bold text-white mb-1' }, '匯入本地檔案'), 
                            React.createElement('p', { className: 'text-xs text-gray-500' }, '選擇多個 JSON 資料分片')
                        ),
                        React.createElement('input', { type: 'file', multiple: true, accept: '.json', className: 'hidden', onChange: onFileImport })
                    )
                );
                
                return React.createElement('div', { className: 'min-h-screen flex flex-col items-center justify-center p-6 bg-[#0c0c0c] text-center space-y-10 fade-in' },
                    React.createElement('div', { className: 'space-y-4' },
                        React.createElement('div', { className: 'w-24 h-24 bg-gradient-to-br from-yellow-600 to-yellow-800 rounded-full flex items-center justify-center mx-auto border-4 border-[#27272a] shadow-2xl' }, renderIco('chef', 'w-12 h-12 text-white')),
                        React.createElement('h1', { className: 'text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-500' }, config.project.title),
                        React.createElement('p', { className: 'text-gray-400 tracking-[0.3em] text-xs uppercase' }, config.project.item_name_tw, ' Database Manager')
                    ),
                    React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-3xl' },
                        FileInput,
                        React.createElement('button', { 
                            onClick: onCloudClick, 
                            className: 'group cursor-pointer bg-[#18181b] border border-[#27272a] p-8 rounded-2xl hover:border-blue-600/50 hover:bg-[#1f1f22] transition-all duration-300 flex flex-col items-center gap-4 shadow-lg' 
                        },
                            React.createElement('div', { className: 'p-4 bg-[#27272a] rounded-full group-hover:bg-blue-900/20 transition-colors' }, renderIco('cloud', 'w-8 h-8 text-blue-500')),
                            React.createElement('div', null, 
                                React.createElement('h3', { className: 'text-xl font-bold text-white mb-1' }, '從雲端 URL 載入'), 
                                React.createElement('p', { className: 'text-xs text-gray-500' }, '貼上 Manifest 或資料 URL')
                            )
                        )
                    )
                );
            };
        })();
        
        const CloudImportModal = (function CloudImportModalComponent() {
            return function CloudImportModal({ onClose, onImport }) {
                const [url, setUrl] = useState("");
                const [loading, setLoading] = useState(false);
                const [error, setError] = useState("");

                const handleImport = async () => {
                    if (!url.trim()) return;
                    setLoading(true);
                    setError("");
                    const fetchUrl = IO.proxyUrl(url.trim());
                    try {
                        const res = await fetch(fetchUrl);
                        if (!res.ok) throw new Error(`HTTP ${res.status}`);
                        const json = await res.json();
                        let data = [];
                        
                        if (json.files && Array.isArray(json.files)) {
                            const promises = json.files.map(file => fetch(IO.proxyUrl(file)).then(r => r.ok ? r.json() : [])).filter(p => p !== null);
                            const results = await Promise.allSettled(promises);
                            data = results.filter(r => r.status === 'fulfilled').map(r => r.value).flat();
                        } else {
                            data = Array.isArray(json) ? json : [json];
                        }

                        if (data.length === 0) throw new Error("Empty JSON");
                        onImport(data);
                        onClose();
                    } catch (err) {
                        setError(`載入失敗: ${err.message}`);
                    } finally { setLoading(false); }
                };

                return React.createElement('div', { className: 'modal-overlay', onClick: onClose },
                    React.createElement('div', { className: 'bg-[#18181b] border border-[#27272a] rounded-xl p-6 w-full max-w-md shadow-2xl', onClick: e => e.stopPropagation() },
                        React.createElement('h3', { className: 'text-lg font-bold text-white mb-4 flex items-center gap-2' }, React.createElement(Ico, { n: 'cloud', c: 'w-5 h-5 text-blue-500' }), '雲端匯入 (Manifest/Data)'),
                        React.createElement('input', { type: 'text', value: url, onChange: e => setUrl(e.target.value), placeholder: '貼上 URL (Google Drive, GitHub Raw...)', className: 'w-full bg-black border border-[#3f3f46] rounded p-3 text-white text-sm mb-2 focus:border-blue-500 focus:outline-none' }),
                        error && React.createElement('p', { className: 'text-red-400 text-sm mb-4' }, error),
                        React.createElement('div', { className: 'flex justify-end gap-2' },
                            React.createElement('button', { onClick: onClose, className: 'px-4 py-2 text-gray-400 hover:text-white text-sm' }, '取消'),
                            React.createElement('button', { onClick: handleImport, disabled: loading, className: 'px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded text-sm transition flex items-center gap-2' },
                                loading && React.createElement(Ico, { n: 'refresh', c: 'w-4 h-4 spin' }), '載入'
                            )
                        )
                    )
                );
            };
        })();

        const ApiKeyModal = (function ApiKeyModalComponent() {
            return function ApiKeyModal({ onClose, onSave, initialKey }) {
                const [key, setKey] = useState(initialKey);
                return React.createElement('div', { className: 'modal-overlay', onClick: onClose },
                    React.createElement('div', { className: 'bg-[#18181b] border border-[#27272a] rounded-xl p-6 w-full max-w-sm', onClick: e => e.stopPropagation() },
                        React.createElement('h3', { className: 'text-lg font-bold text-white mb-4 flex items-center gap-2' }, React.createElement(Ico, { n: 'settings' }), '設定 Gemini API Key'),
                        React.createElement('input', { type: 'password', value: key, onChange: e => setKey(e.target.value), placeholder: '貼上 Gemini Key', className: 'w-full bg-black border border-[#3f3f46] rounded p-3 text-white mb-4 focus:border-yellow-600 focus:outline-none' }),
                        React.createElement('div', { className: 'flex justify-end' },
                            React.createElement('button', { onClick: () => onSave(key), className: 'px-4 py-2 bg-yellow-600 text-black font-bold rounded' }, '儲存')
                        )
                    )
                );
            };
        })();
        
        // --- 5. Main App Execution ---
        const App = () => {
            const [db, setDb] = useState([]);
            const [loading, setLoading] = useState(true);
            const [configLoadError, setConfigLoadError] = useState(null);
            const [query, setQuery] = useState("");
            const [filters, setFilters] = useState({ brand: "All", type: "All", capacity: "All" });
            const [config, setConfig] = useState(EMBEDDED_CONFIG); // Use EMBEDDED_CONFIG directly
            
            const [keyModal, setKeyModal] = useState(false);
            const [cloudModal, setCloudModal] = useState(false);
            const [apiKey, setApiKey] = useState("");
            
            const [modalState, setModalState] = useState({ open: false, loading: false, title: "", content: "", type: "", error: "", results: [] });

            // --- INIT ---
            useEffect(() => {
                const init = async () => {
                    const projectConfig = EMBEDDED_CONFIG;
                    
                    const projectLSKey = LS_KEY_PREFIX + projectConfig.project.item_name_tw.replace(/\s/g, '');
                    const key = IO.get("GEMINI_KEY");
                    if(key) setApiKey(key);

                    let initialData = [];
                    const local = IO.get(projectLSKey);
                    
                    if(local) {
                        try {
                            const parsed = IO.parse(local);
                            if(Array.isArray(parsed) && parsed.length) initialData = parsed.map(IO.enrich).filter(x=>x);
                        } catch {}
                    }

                    if (initialData.length === 0) {
                        try {
                            const manifestRes = await fetch(projectConfig.db_config.manifest_file);
                            if (manifestRes.ok) {
                                const manifest = await manifestRes.json();
                                const promises = (manifest.files || []).map(file => 
                                    fetch(file).then(res => res.ok ? res.json() : [])
                                );
                                const results = await Promise.allSettled(promises);
                                initialData = results.filter(r => r.status === 'fulfilled').map(r => r.value).flat().map(IO.enrich).filter(x => x);
                                if(initialData.length > 0) IO.set(projectLSKey, JSON.stringify(initialData));
                            }
                        } catch (e) { console.warn("Manifest load failed:", e.message); }
                    }

                    setDb(initialData);
                    setLoading(false);
                };
                init();
            }, []);

            // Persist DB state based on current project
            useEffect(() => {
                if (db.length > 0 && config) {
                    const projectLSKey = LS_KEY_PREFIX + config.project.item_name_tw.replace(/\s/g, '');
                    IO.set(projectLSKey, JSON.stringify(db));
                }
            }, [db, config]);


            // Filtered Data Logic (The core logic to fix)
            const filteredData = useMemo(() => {
                if (!config) return [];
                let res = db;
                
                // 1. Dropdown Filters
                if (filters.brand !== "All") res = res.filter(i => i.brand === filters.brand);
                if (filters.type !== "All") res = res.filter(i => i.type === filters.type);
                if (filters.capacity !== "All") res = res.filter(i => i.capacity === filters.capacity);
                
                // 2. Keyword Filter (The fix for broken keyword search)
                const q = query.trim();
                if (q.length > 0) {
                    const lowerQ = q.toLowerCase();
                    res = res.filter(i => 
                        (i.brand || "").toLowerCase().includes(lowerQ) || 
                        (i.model || "").toLowerCase().includes(lowerQ) || 
                        (i.type || "").includes(lowerQ) // Assuming type is often already in TW or matching TW Pinyin/English parts
                    );
                }
                return res;
            }, [db, filters, query, config]);

            const options = useMemo(() => ({
                brand: ["All", ...new Set(db.map(i => i.brand))].sort(),
                type: ["All", ...new Set(db.map(i => i.type))].sort(),
                capacity: ["All", ...new Set(db.map(i => i.capacity))].sort()
            }), [db]);


            // Import Logic (Skipped for brevity)
            const handleImport = (newData) => {
                if(!newData || !Array.isArray(newData)) return;
                setDb(prev => {
                    const ids = new Set(prev.map(i => i.id));
                    const unique = newData.filter(i => !ids.has(i.id)).map(IO.enrich).filter(x=>x);
                    if(unique.length === 0) return prev;
                    return [...unique, ...prev];
                });
            };

            const handleFileImport = async (e) => {
                const files = Array.from(e.target.files);
                if(!files.length) return;
                
                const readPromises = files.map(file => new Promise(resolve => {
                    const r = new FileReader();
                    r.onload = evt => {
                        try { resolve(JSON.parse(evt.target.result)); } 
                        catch { resolve([]); }
                    };
                    r.readAsText(file);
                }));

                const rawResults = await Promise.all(readPromises);
                const flatItems = rawResults.flat().map(IO.enrich).filter(x=>x);
                
                if(flatItems.length > 0) {
                    handleImport(flatItems);
                    alert(`Imported ${flatItems.length} items.`);
                } else {
                    alert("No valid data found.");
                }
                e.target.value = null;
            };

            const handleWebSearch = async (e) => {
                if (e) e.preventDefault();
                if(!query.trim()) return; 
                if(!apiKey) return setKeyModal(true);

                setModalState({ open: true, title: "網路搜尋中...", content: "", loading: true, type: "search", error: "", results: [] });
                
                setTimeout(async () => {
                    const prompt = `Search gear: "${query}". Return JSON ARRAY. System instruction: ${config.ai_prompts.search_system}. ${config.ai_prompts.search_prompt_schema} Return ONLY JSON.`;
                    
                    try {
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=${apiKey}`, {
                            method: 'POST', headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], tools: [{"google_search":{}}] })
                        });
                        
                        if (!res.ok) {
                            const errData = await res.json();
                            throw new Error(errData.error?.message || `HTTP ${res.status}`);
                        }
                        
                        const data = await res.json();
                        const jsonStr = data.candidates?.[0]?.content?.parts?.[0]?.text;
                        const parsed = IO.parseJSON(jsonStr);
                        
                        if(!parsed || !Array.isArray(parsed) || parsed.length === 0) throw new Error("AI returned invalid data or no results.");

                        setModalState({ 
                            open: true, 
                            title: `網路搜尋結果 (找到 ${parsed.length} 筆)`, 
                            content: "", 
                            loading: false, 
                            type: "search-results", 
                            results: parsed.map(IO.enrich).filter(x=>x) 
                        });
                        
                    } catch (err) { 
                        setModalState({ open: true, title: "網路搜尋失敗", content: "", loading: false, type: "error", error: err.message }); 
                    }
                }, 0); 
            };

            const handleAI = (mode, item) => {
                if(!apiKey) return setKeyModal(true);

                let extra = "中焙"; 
                if(mode !== 'snark') {
                     // In a later version, this is where the recipe selection logic (light/medium/dark) would go
                }

                const initialTitle = mode === 'snark' ? `${config.ai_prompts.review_title}: ${item.model}` : `${config.ai_prompts.recipe_title}: ${item.model}`;
                setModalState({ open: true, title: initialTitle, content: "", loading: true, type: mode, error: "" });

                setTimeout(async () => {
                    let prompt = "";
                    let systemInstruction = "";

                    if(mode === 'snark') {
                        prompt = `針對以下器材：${item.brand} ${item.model} (${item.type}, ${item.feature})。請用此系統指令進行評論。`;
                        systemInstruction = config.ai_prompts.review_prompt_system;
                    } else if (mode === 'recipe') {
                        prompt = `針對 ${item.brand} ${item.model}，提供一份適合「${extra}」烘焙豆的具體沖煮參數（粉水比、研磨度、水溫、注水手法）。`;
                        systemInstruction = config.ai_prompts.recipe_prompt_system;
                    }
                    
                    try {
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=${apiKey}`, {
                            method: 'POST', headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ 
                                contents: [{ parts: [{ text: prompt }] }],
                                systemInstruction: { parts: [{ text: systemInstruction }] }
                            })
                        });
                        
                        if (!res.ok) {
                            const errData = await res.json();
                            throw new Error(errData.error?.message || `HTTP ${res.status}`);
                        }
                        
                        const data = await res.json();
                        const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                        
                        if (!text) throw new Error("Empty AI response");
                        
                        setModalState(prev => ({ ...prev, content: text, loading: false, error: "" }));
                    } catch (err) { 
                        setModalState(prev => ({ ...prev, title: "AI 呼叫失敗", content: "", loading: false, type: "error", error: err.message }));
                    }
                }, 0);
            };


            // Main Render Logic
            if(loading) return (
                React.createElement('div', { className: "min-h-screen bg-[#0c0c0c] flex flex-col items-center justify-center p-8" },
                    React.createElement('div', { className: "w-12 h-12 border-4 border-yellow-600 rounded-full spin border-t-transparent mb-4" })
                )
            );


            if (db.length === 0) {
                return (
                    React.createElement(React.Fragment, null,
                        React.createElement(WelcomeScreen, { onFileImport: handleFileImport, onCloudClick: () => setCloudModal(true), config: config }),
                        cloudModal && React.createElement(CloudImportModal, { onClose: () => setCloudModal(false), onImport: handleImport }),
                        keyModal && React.createElement(ApiKeyModal, { onClose: () => setKeyModal(false), onSave: handleKeySave, initialKey: apiKey })
                    )
                );
            }

            return (
                React.createElement('div', { className: "min-h-screen bg-[#0c0c0c] pb-20 fade-in text-base" },
                    React.createElement('nav', { className: "sticky top-0 z-40 bg-[#0c0c0c]/90 backdrop-blur border-b border-[#27272a] px-4 py-3 shadow-lg" },
                        React.createElement('div', { className: "max-w-[1600px] mx-auto flex flex-col md:flex-row items-center justify-between gap-4" },
                            React.createElement('div', { className: "flex items-center gap-2 flex-shrink-0" },
                                React.createElement('span', { className: "bg-yellow-500 text-black px-2 py-0.5 rounded font-black text-xs" }, config.project.version),
                                React.createElement('h1', { className: "font-bold text-gray-100 tracking-tight text-lg" }, config.ui_labels.header_title)
                            ),
                            React.createElement('form', { onSubmit: handleWebSearch, className: "relative w-full max-w-xl group flex gap-2" },
                                React.createElement('div', { className: "relative flex-1" },
                                    React.createElement('div', { className: "absolute left-3 top-2.5 text-gray-500" }, React.createElement(Ico, { n: "search", c: "w-4 h-4" })),
                                    React.createElement('input', { type: "text", value: query, onChange: e => setQuery(e.target.value), placeholder: config.ui_labels.search_placeholder, className: "w-full bg-[#18181b] border border-[#27272a] text-gray-200 rounded-lg pl-9 pr-4 py-2 focus:border-yellow-600 focus:outline-none transition-all" })
                                ),
                                React.createElement('button', { type: "submit", className: "flex items-center justify-center p-2 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-lg transition", title: "Search Web" }, React.createElement(Ico, { n: "search", c: "w-5 h-5" }))
                            ),
                            React.createElement('div', { className: "flex items-center gap-2 w-full md:w-auto overflow-x-auto pb-1 md:pb-0" },
                                React.createElement('select', { className: "bg-[#18181b] border border-[#27272a] text-gray-300 rounded px-2 py-2 cursor-pointer focus:outline-none text-sm", value: filters.brand, onChange: e => setFilters({ ...filters, brand: e.target.value }) }, options.brand.map(o => React.createElement('option', { key: o, value: o }, o))),
                                React.createElement('select', { className: "bg-[#18181b] border border-[#27272a] text-gray-300 rounded px-2 py-2 cursor-pointer focus:outline-none text-sm", value: filters.type, onChange: e => setFilters({ ...filters, type: e.target.value }) }, options.type.map(o => React.createElement('option', { key: o, value: o }, o))),
                                React.createElement('button', { onClick: () => setKeyModal(true), className: `p-2 rounded border transition ${apiKey ? 'border-green-900 text-green-500 bg-green-900/10' : 'border-[#27272a] text-gray-400 bg-[#18181b] hover:text-white'}` }, React.createElement(Ico, { n: "settings" }))
                            )
                        )
                    ),

                    React.createElement('main', { className: "max-w-[1600px] mx-auto p-4" },
                        React.createElement('div', { className: "flex justify-between items-end mb-4 px-1" },
                            React.createElement('p', { className: "text-gray-500 text-xs font-mono" }, "ITEMS: ", React.createElement('span', { className: "text-yellow-500" }, filteredData.length))
                        ),

                        filteredData.length > 0 ? (
                            React.createElement('div', { className: "tetris-grid" },
                                filteredData.map(item => React.createElement(Card, { key: item.id, item: item, spanClass: IO.getSpanClass(item), onAI: handleAI, config: config }))
                            )
                        ) : (
                            React.createElement('div', { className: "flex flex-col items-center justify-center py-20 text-gray-600 border-2 border-dashed border-[#27272a] rounded-xl" },
                                React.createElement(Ico, { n: "cloud", c: "w-12 h-12 mb-4 opacity-20" }),
                                React.createElement('p', { className: "text-lg font-bold text-gray-500 mb-4" }, "NO MATCH FOUND")
                            )
                        )
                    ),

                    React.createElement('footer', { className: "fixed bottom-0 left-0 w-full bg-[#0c0c0c] border-t border-[#27272a] py-3 px-6 z-30 flex justify-between items-center text-base text-gray-500" },
                        React.createElement('div', { className: "flex gap-3" },
                            React.createElement('button', { onClick: handleReset, className: "hover:text-red-500 flex items-center gap-1 transition text-sm" }, React.createElement(Ico, { n: "trash" }), " RESET"),
                            React.createElement('button', { onClick: () => setCloudModal(true), className: "hover:text-blue-500 flex items-center gap-1 transition text-sm" }, React.createElement(Ico, { n: "cloud" }), " CLOUD")
                        ),
                        React.createElement('div', { className: "flex items-center gap-3" },
                            React.createElement('button', { onClick: handleExport, className: "hover:text-blue-400 flex items-center gap-1 transition text-sm" }, React.createElement(Ico, { n: "download" }), " BACKUP"),
                            React.createElement('label', { className: "hover:text-green-400 flex items-center gap-1 cursor-pointer transition text-sm" }, React.createElement(Ico, { n: "upload" }), " FILE", React.createElement('input', { type: "file", multiple: true, accept: ".json", className: "hidden", onChange: handleFileImport }))
                        )
                    ),

                    // Modals
                    React.createElement(Modal, { modalState: modalState, setModalState: setModalState, onAddFromSearch: addItemFromSearch, config: config }),
                    keyModal && React.createElement(ApiKeyModal, { onClose: () => setKeyModal(false), onSave: handleKeySave, initialKey: apiKey }),
                    cloudModal && React.createElement(CloudImportModal, { onClose: () => setCloudModal(false), onImport: handleImport })
                )
            );
        };
        
        // --- 6. Final Execution ---
        window.onload = function() {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(React.createElement(App, null));
        };
    </script>
</body>
</html>