<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coffee Geek Finder v51.0 | Pure JS</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { background-color: #0c0c0c; color: #e5e5e5; font-family: system-ui, -apple-system, sans-serif; overflow-x: hidden; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0c0c0c; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .tetris-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            grid-auto-rows: auto; 
            grid-auto-flow: dense; 
            gap: 1.5rem; 
        }

        /* Markdown Styles */
        .mkd h1, .mkd h2, .mkd h3 { color: #facc15; font-weight: 700; margin-top: 1em; margin-bottom: 0.5em; border-bottom: 1px solid #333; padding-bottom: 0.3em; }
        .mkd ul { list-style: disc; padding-left: 1.5em; color: #a8a29e; margin-bottom: 1em; }
        .mkd ol { list-style: decimal; padding-left: 1.5em; color: #a8a29e; margin-bottom: 1em; }
        .mkd li { margin-bottom: 0.2em; }
        .mkd strong { color: #fff; font-weight: 600; }
        .mkd p { margin-bottom: 0.8em; line-height: 1.6; }
        .mkd table { border-collapse: collapse; width: 100%; margin: 1em 0; font-size: 0.9em; }
        .mkd th, .mkd td { border: 1px solid #444; padding: 0.5em; text-align: left; }
        .mkd th { background-color: #222; color: #facc15; }

        .top-tools-container {
            border-bottom: 1px solid #27272a;
            padding: 0.75rem 0; 
            margin-bottom: 1rem;
        }

        /* Native Dialog Styles */
        dialog {
            background-color: #18181b;
            border: 1px solid #27272a;
            border-radius: 0.75rem;
            padding: 1.5rem;
            color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }
        dialog::backdrop {
            background-color: rgba(0, 0, 0, 0.8);
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="modal-root"></div>
    
    <!-- Native API Key Dialog -->
    <dialog id="native-api-key-dialog">
        <form method="dialog" id="api-key-form" class="w-full max-w-sm">
            <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">ðŸ”‘ API Key</h3>
            <input type="password" name="key" placeholder="Paste Gemini Key" 
                   class="w-full bg-black border border-[#3f3f46] rounded p-3 text-white mb-4 focus:border-yellow-600 focus:outline-none"/>
            <div class="flex justify-end">
                <button type="submit" id="native-api-key-save" 
                        class="px-4 py-2 bg-yellow-600 text-black font-bold rounded hover:bg-yellow-500">SAVE</button>
            </div>
        </form>
    </dialog>

    <!-- Native Loading Dialog -->
    <dialog id="native-loading-dialog" class="w-full max-w-sm">
        <div class="flex flex-col items-center py-5">
            <div class="w-10 h-10 border-2 border-yellow-600 border-t-transparent rounded-full spin"></div>
            <p id="native-loading-title" class="mt-4 text-gray-300">Loading...</p>
        </div>
    </dialog>

    <script>
        const { useState, useEffect, useMemo, useRef } = React;
        const e = React.createElement; 
        const ReactDOM = window.ReactDOM; 
        
        const CFG = {
            LS_KEY: "CGF_DB_V41_FINAL",
            API_MODEL: "gemini-2.5-flash-preview-09-2025",
            MANIFEST_FILE: "./db_manifest.json" 
        };

        const eventBus = {
            listeners: {},
            on(event, callback) {
                if (!this.listeners[event]) this.listeners[event] = [];
                this.listeners[event].push(callback);
            },
            emit(event, data) {
                if (this.listeners[event]) {
                    this.listeners[event].forEach(callback => callback(data));
                }
            }
        };

        const IO = {
            get: (k) => { try { return localStorage.getItem(k); } catch { return null; } },
            set: (k, v) => { try { localStorage.setItem(k, v); return true; } catch { return false; } },
            del: (k) => { try { localStorage.removeItem(k); } catch {} },
            
            genId: (list) => (list || []).reduce((max, item) => Math.max(max, Number(item.id) || 0), 0) + 1,

            enrich: (raw) => {
                if (!raw || typeof raw !== 'object') return null;
                const { id, brand, model, type, priceLevel, capacity, feature, pros, cons, sentiment, verdict } = raw;
                return {
                    id: id || Date.now() + Math.random(),
                    brand: String(brand || "Unknown"),
                    model: String(model || "Unknown Model"),
                    type: String(type || "Equipment"),
                    priceLevel: String(priceLevel || "$"),
                    capacity: String(capacity || "N/A"),
                    feature: String(feature || ""),
                    pros: Array.isArray(pros) ? pros : [],
                    cons: Array.isArray(cons) ? cons : [],
                    sentiment: Array.isArray(sentiment) ? sentiment : [{ name: "N/A", value: 100, color: "#555" }],
                    verdict: verdict || "No verdict available."
                };
            },

            parseJSON: (text) => {
                if (!text) return null;
                try {
                    const clean = text.replace(/```json|```/g, '').trim();
                    const start = clean.indexOf('[');
                    const end = clean.lastIndexOf(']');
                    return JSON.parse(clean.substring(start, end + 1));
                } catch (err) {
                    try { return JSON.parse(clean); } catch (e2) { return null; }
                }
            },

            getSpanClass: (item) => {
                let score = 0;
                const pros = item.pros || [];
                const cons = item.cons || [];
                const len = (item.verdict || "").length;
                if (pros.length + cons.length >= 5) score += 2;
                if (item.priceLevel === "$$$$$") score += 2;
                else if (item.priceLevel === "$$$$") score += 1;
                if (len > 25) score += 1;
                const hash = (parseInt(item.id) || 0) % 3;
                if (score >= 4) return "col-span-1 md:col-span-2 row-span-2"; 
                if (score === 3) return hash === 0 ? "col-span-1 md:col-span-2 row-span-1" : "col-span-1 row-span-2";
                return "col-span-1 row-span-1";
            },

            getFeatureLabel: (type) => {
                const t = (type || "").toLowerCase();
                if(t.includes("ç£¨") || t.includes("grinder")) return "åˆ€ç›¤";
                if(t.includes("æ¿¾") || t.includes("å£º") || t.includes("filter")) return "çµæ§‹";
                if(t.includes("ç§¤") || t.includes("scale")) return "ç‰¹æ€§";
                if(t.includes("å£“") || t.includes("press")) return "æ©Ÿåˆ¶";
                return "ç‰¹é»ž";
            },

            proxyUrl: (url) => {
                const match = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)\//);
                if (match && match[1]) {
                    return `https://api.allorigins.win/raw?url=${encodeURIComponent(`https://drive.google.com/uc?export=download&id=${match[1]}`)}`;
                }
                return url;
            }
        };

        const Icon = React.memo(({ n, c = "w-4 h-4" }) => {
            const paths = {
                search: "m21 21-4.3-4.3M11 19a8 8 0 1 0 0-16 8 8 0 0 0 0 16z",
                cloud: "M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242",
                upload: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12",
                settings: "M12.22 2h-.44a2 2 0 0 1-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l-.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z M12 9a3 3 0 1 0 0 6 3 3 0 0 0 0-6z",
                plus: "M12 5v14M5 12h14",
                trash: "M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",
                download: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3",
                msg: "M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z",
                chef: "M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 9.08 0A5.11 5.11 0 0 1 18.59 6 4 4 0 0 1 20 13.87V21H6Z M6 17h14",
                scale: "M6 20h12a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2z M12 14v4 M12 2v4",
                tag: "M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z M7 7h.01",
                image: "M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z M12 17a4 4 0 1 0 0-8 4 4 0 0 0 0 8z",
                up: "M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3",
                down: "M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2h-3",
                refresh: "M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16",
                close: "M18 6 6 18 M6 6 18 18",
                undo: "M21 21L12 12M12 12V3h9"
            };
            return e('svg', { viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: c }, e('path', { d: paths[n] || "" }));
        });

        const PieChart = React.memo(({ data }) => {
            if(!data || !data.length) return null;
            const total = data.reduce((s, i) => s + (i.value || 0), 0);
            const items = data.map(i => ({...i, percent: (i.value || 0) / total}));
            let cumulativePercent = 0;
            const getCoords = (pct) => [Math.cos(2*Math.PI*pct), Math.sin(2*Math.PI*pct)];

            const paths = items.map((slice, i) => {
                const start = cumulativePercent;
                const end = start + slice.percent;
                cumulativePercent = end;
                const [sx, sy] = getCoords(start);
                const [ex, ey] = getCoords(end);
                const large = slice.percent > 0.5 ? 1 : 0;
                const d = `M ${sx} ${sy} A 1 1 0 ${large} 1 ${ex} ${ey} L ${ex*0.65} ${ey*0.65} A 0.65 0.65 0 ${large} 0 ${sx*0.65} ${sy*0.65} Z`;
                return e('path', { key: i, d: d, fill: slice.color, stroke: "#18181b", strokeWidth: "0.02", className: "hover:opacity-80 transition-opacity"});
            });

            return e('svg', { viewBox: "-1.1 -1.1 2.2 2.2", className: "w-full h-full -rotate-90" }, paths);
        });

        const Card = React.memo(({ item, spanClass, onAI }) => {
            const [menuOpen, setMenuOpen] = useState(false);
            if (!item) return null;

            const isHuge = spanClass.includes('row-span-2') && spanClass.includes('col-span-2');
            const isBig = spanClass.includes('row-span-2') || spanClass.includes('col-span-2');
            
            const typo = {
                brand: isHuge ? "text-lg font-black tracking-[0.2em]" : "text-xs font-bold tracking-widest",
                title: isHuge ? "text-5xl md:text-6xl mt-2 mb-4" : (isBig ? "text-3xl mt-1 mb-2" : "text-xl"),
                verdict: isHuge ? "text-base" : (isBig ? "text-base" : "text-sm"),
                listText: isHuge ? "text-base" : "text-xs",
                btn: isHuge ? "text-sm py-2.5" : "text-xs py-2",
                featLabel: isHuge ? "text-sm" : "text-xs",
                feat: isHuge ? "text-lg" : "text-sm"
            };

            const searchUrl = (type) => {
                const q = encodeURIComponent(`${item.brand || ''} ${item.model || ''}`);
                return type === 'shopee' ? `https://shopee.tw/search?keyword=${q}` : `https://www.momoshop.com.tw/search/searchShop.jsp?keyword=${q}`;
            };

            const handleImageSearch = () => {
                const q = encodeURIComponent(`${item.brand || ''} ${item.model || ''} ${item.type || ''}`);
                window.open(`https://www.google.com/search?tbm=isch&q=${q}`, '_blank');
            };
            
            const prosList = item.pros.slice(0, isHuge ? 8 : 3).map((p,i)=>e('li', { key: i, className: `flex items-start ${typo.listText}` }, e('span', { className: "mr-1.5 text-emerald-500/50" }, 'â€¢'), e('span', { className: "truncate" }, p)));
            const consList = item.cons.slice(0, isHuge ? 8 : 3).map((c,i)=>e('li', { key: i, className: `flex items-start ${typo.listText}` }, e('span', { className: "mr-1.5 text-rose-500/50" }, 'â€¢'), e('span', { className: "truncate" }, c)));

            return e('div', { className: `bg-[#18181b] border border-[#27272a] rounded-xl p-5 flex flex-col gap-3 hover:border-yellow-600/50 hover:shadow-2xl transition-all duration-300 relative h-full group ${spanClass}` }, 
                e('div', { className: "flex justify-between items-start" }, 
                    e('div', { className: "min-w-0 pr-2 flex-1" }, 
                        e('span', { className: `text-yellow-500 uppercase block truncate ${typo.brand}` }, item.brand),
                        e('h3', { className: `font-bold text-gray-100 leading-none truncate ${typo.title}` }, item.model),
                        e('div', { className: "flex gap-2 mt-2" }, 
                            e('span', { className: "flex items-center gap-1 bg-[#27272a] text-gray-400 px-2 py-1 rounded border border-[#3f3f46] text-xs" }, e(Icon, { n: "tag", c: "w-3 h-3" }), item.type),
                            e('span', { className: "flex items-center gap-1 bg-[#27272a] text-gray-400 px-2 py-1 rounded border border-[#3f3f46] text-xs" }, e(Icon, { n: "scale", c: "w-3 h-3" }), item.capacity)
                        )
                    ),
                    e('button', { onClick: handleImageSearch, className: "flex items-center gap-1 bg-[#27272a] hover:bg-[#3f3f46] text-gray-400 hover:text-white px-2 py-1.5 rounded border border-[#3f3f46] transition-colors flex-shrink-0", title: "Image Search" }, e(Icon, { n: "image", c: "w-4 h-4" }), e('span', { className: isBig ? "text-xs ml-1" : "hidden" }, "Image"))
                ),
                e('div', { className: "bg-[#27272a]/50 p-3 rounded border-l-4 border-yellow-600 flex flex-col gap-1" }, 
                    e('div', { className: "flex justify-between items-center text-xs font-bold tracking-wider text-gray-500 mb-1" }, 
                        e('span', null, "GEEK VERDICT"),
                        e('span', { className: "text-yellow-500 font-mono text-base" }, item.priceLevel)
                    ),
                    e('p', { className: `text-gray-300 italic leading-relaxed ${typo.verdict}` }, `"${item.verdict}"`)
                ),
                e('div', { className: `grid grid-cols-2 gap-4 flex-grow ${isBig ? 'overflow-auto' : 'overflow-hidden'}` }, 
                    e('div', null, 
                        e('span', { className: `text-emerald-500 font-bold block tracking-wide flex items-center gap-1 mb-1 ${typo.listText}` }, e(Icon, { n: "up", c: "w-3 h-3" }), "PROS"),
                        e('ul', { className: "space-y-1 text-gray-400" }, prosList)
                    ),
                    e('div', null, 
                        e('span', { className: `text-rose-500 font-bold block tracking-wide flex items-center gap-1 mb-1 ${typo.listText}` }, e(Icon, { n: "down", c: "w-3 h-3" }), "CONS"),
                        e('ul', { className: "space-y-1 text-gray-400" }, consList)
                    )
                ),
                e('div', { className: "flex items-center justify-between border-t border-[#27272a] pt-3 mt-auto" }, 
                    e('div', { className: `${isHuge ? 'w-16 h-16' : 'w-12 h-12'} relative flex-shrink-0 mr-4` }, e(PieChart, { data: item.sentiment })),
                    e('div', { className: "flex flex-col items-end" }, 
                        e('span', { className: `text-gray-500 uppercase font-bold ${typo.featLabel}` }, IO.getFeatureLabel(item.type)),
                        e('span', { className: `text-gray-200 font-mono border border-[#3f3f46] bg-[#27272a] px-2 py-0.5 rounded ${typo.feat}` }, item.feature || "N/A")
                    )
                ),
                e('div', { className: "grid grid-cols-2 gap-2 mt-2" }, 
                    e('button', { onClick: ()=>onAI('snark', item), className: `flex items-center justify-center gap-1 bg-indigo-900/20 text-indigo-300 border border-indigo-500/30 rounded hover:bg-indigo-900/40 transition ${typo.btn}` }, e(Icon, { n: "msg", c: "w-3 h-3" }), isHuge ? 'AI Review' : 'Review'),
                    e('div', { className: "relative" }, 
                        e('button', { onClick: ()=>setMenuOpen(!menuOpen), className: `w-full flex items-center justify-center gap-1 bg-emerald-900/20 text-emerald-300 border border-emerald-500/30 rounded hover:bg-emerald-900/40 transition ${typo.btn}` }, e(Icon, { n: "chef", c: "w-3 h-3" }), isHuge ? 'AI Recipe' : 'Recipe'),
                        menuOpen && (
                            e('div', { className: "absolute bottom-full left-0 w-full mb-1 bg-[#27272a] border border-[#3f3f46] rounded shadow-xl z-20 flex flex-col overflow-hidden" },
                                ['æ·ºç„™','ä¸­ç„™','æ·±ç„™'].map(r => (
                                    e('button', { key: r, onClick: ()=>{onAI('recipe', item, r); setMenuOpen(false)}, className: "px-3 py-2 text-left text-xs text-gray-300 hover:bg-[#3f3f46] hover:text-white transition" }, r)
                                ))
                            )
                        )
                    ),
                    e('a', { href: searchUrl('shopee'), target: "_blank", className: `flex items-center justify-center gap-1 bg-[#ee4d2d] text-white font-bold rounded hover:opacity-90 transition ${typo.btn}` }, "Shopee"),
                    e('a', { href: searchUrl('momo'), target: "_blank", className: `flex items-center justify-center gap-1 bg-[#d63086] text-white font-bold rounded hover:opacity-90 transition ${typo.btn}` }, "MOMO")
                )
            );
        });
        
        const SearchResultModal = ({ results, onClose, onAdd }) => {
            const resultList = results.map(item => (
                e('div', { key: item.id, className: "bg-[#1f1f22] border border-[#27272a] rounded-lg p-4 flex flex-col gap-2 hover:border-yellow-600/50" },
                    e('div', { className: "flex justify-between" },
                        e('span', { className: "text-xs text-yellow-500 font-bold" }, item.brand),
                        e('span', { className: "text-xs text-gray-400" }, item.type)
                    ),
                    e('h4', { className: "text-base font-bold text-white" }, item.model),
                    e('p', { className: "text-sm text-gray-400 italic line-clamp-2" }, `"${item.verdict}"`),
                    e('button', { 
                        onClick: () => onAdd(item),
                        className: "mt-auto w-full py-2 bg-emerald-900/30 text-emerald-400 border border-emerald-800 rounded hover:bg-emerald-900/50 text-sm flex items-center justify-center gap-2"
                    }, e(Icon, { n: "plus", c: "w-3 h-3" }), " Add to DB")
                )
            ));

            return e('div', { className: "fixed inset-0 z-[9000] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4", onClick: onClose },
                e('div', { className: "bg-[#18181b] border border-[#27272a] rounded-xl w-full max-w-4xl max-h-[85vh] flex flex-col shadow-2xl overflow-hidden", onClick: e=>e.stopPropagation() },
                    e('div', { className: "p-4 border-b border-[#27272a] bg-[#0c0c0c] flex justify-between items-center shrink-0" },
                        e('h3', { className: "font-bold text-yellow-500 flex items-center gap-2" }, e(Icon, { n: "search", c: "w-5 h-5" }), ` Found ${results.length} Web Results`),
                        e('button', { onClick: onClose, className: "text-gray-500 hover:text-white text-xl" }, e(Icon, { n: "close", c: "w-5 h-5" }))
                    ),
                    e('div', { className: "p-6 overflow-y-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 bg-[#0c0c0c]" }, resultList)
                )
            );
        };
        
        const CloudImportModal = ({ onClose, onImport, importing, setImporting }) => {
            const [url, setUrl] = useState("");
            const [error, setError] = useState("");

            const handleImport = async () => {
                if (!url.trim()) return;
                setImporting(true);
                setError("");
                const fetchUrl = IO.proxyUrl(url.trim());
                try {
                    const res = await fetch(fetchUrl);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const json = await res.json();
                    const data = Array.isArray(json) ? json : [json];
                    if (data.length === 0) throw new Error("Empty JSON");
                    onImport(data);
                    onClose();
                } catch (err) {
                    setError("Import failed. Check URL permissions.");
                } finally { setImporting(false); }
            };

            return e('div', { className: "fixed inset-0 z-[9000] flex items-center justify-center bg-black/90 backdrop-blur-sm p-4", onClick: onClose },
                e('div', { className: "bg-[#18181b] border border-[#27272a] rounded-xl p-6 w-full max-w-md shadow-2xl", onClick: e=>e.stopPropagation() },
                    e('h3', { className: "text-lg font-bold text-white mb-4 flex items-center gap-2" }, e(Icon, { n: "cloud", c: "w-5 h-5 text-blue-500" }), " Cloud Import"),
                    e('input', { type: "text", value: url, onChange: e=>setUrl(e.target.value), placeholder: "Paste URL here...", className: "w-full bg-black border border-[#3f3f46] rounded p-3 text-white text-sm mb-2 focus:border-blue-500 focus:outline-none" }),
                    error && e('p', { className: "text-red-400 text-sm mb-4" }, error),
                    e('div', { className: "flex justify-end gap-2" },
                        e('button', { onClick: onClose, className: "px-4 py-2 text-gray-400 hover:text-white text-sm" }, "Cancel"),
                        e('button', { onClick: handleImport, disabled: importing, className: "px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded text-sm transition flex items-center gap-2" },
                            importing && e(Icon, { n: "refresh", c: "w-4 h-4 spin" }), " Import"
                        )
                    )
                )
            );
        };
        
        const GlobalModal = () => {
            const [modal, setModal] = useState({ open: false, title: "", content: "", loading: false, type: "" });
            const [updateTimestamp, setUpdateTimestamp] = useState(Date.now());
            
            useEffect(() => {
                const listener = (data) => {
                    setModal(data);
                    setUpdateTimestamp(Date.now());
                };
                eventBus.on('SHOW_MODAL', listener);
                // Simple removal via assignment not strictly safe if multiple listeners, but fine for this single instance pattern
                return () => eventBus.listeners['SHOW_MODAL'] = (eventBus.listeners['SHOW_MODAL'] || []).filter(l => l !== listener);
            }, []);

            if (!modal.open) return null;

            return ReactDOM.createPortal(
                e('div', { key: updateTimestamp, className: "fixed inset-0 z-[9001] flex items-center justify-center bg-black/80 p-4", onClick: ()=>!modal.loading && setModal({open:false}) },
                    e('div', { className: "bg-[#18181b] border border-[#27272a] rounded-xl w-full max-w-2xl max-h-[80vh] flex flex-col overflow-hidden", onClick: e=>e.stopPropagation() },
                        e('div', { className: "p-4 border-b border-[#27272a] bg-[#0c0c0c] flex justify-between items-center shrink-0" },
                            e('h3', { className: "font-bold text-yellow-500 flex items-center gap-2" },
                                e(Icon, { n: modal.loading?"refresh":"msg", c: `w-5 h-5 ${modal.loading?"spin":""}` }), modal.title
                            ),
                            e('button', { onClick: ()=>setModal({open:false}), className: "text-gray-500 hover:text-white text-xl" }, e(Icon, { n: "close", c: "w-5 h-5" }))
                        ),
                        e('div', { className: "p-6 overflow-y-auto text-gray-300 mkd" },
                            modal.loading 
                                ? e('div', { className: "flex flex-col items-center py-10" }, e('div', { className: "w-10 h-10 border-2 border-yellow-600 border-t-transparent rounded-full spin" }))
                                : e('div', { dangerouslySetInnerHTML: { __html: marked.parse(modal.content||"") } })
                        )
                    )
                ),
                document.getElementById('modal-root')
            );
        };
        
        // Native API Key Dialog Logic
        const showNativeKeyDialog = (onKeySaved) => {
            const dialog = document.getElementById('native-api-key-dialog');
            const form = document.getElementById('api-key-form');
            const input = form.querySelector('[name="key"]');

            if (!dialog || !form || !input) return alert("Native Dialog element not found.");

            input.value = IO.get("GEMINI_KEY") || ""; 

            const handleClose = () => {
                form.removeEventListener('submit', handleSubmit);
                dialog.removeEventListener('close', handleClose);
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const key = input.value.trim();
                if (key && key.length > 10) {
                    onKeySaved(key);
                    dialog.close();
                } else {
                    alert("Invalid API Key.");
                }
            };
            
            form.addEventListener('submit', handleSubmit);
            dialog.addEventListener('close', handleClose);

            try {
                dialog.showModal();
            } catch (error) {
                console.error("Failed to show native dialog:", error);
                alert("ç„¡æ³•é–‹å•Ÿ API Key è¦–çª—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®šã€‚");
            }
        };

        // MISSING FUNCTION IMPLEMENTATION
        const showNativeResult = (title, content) => {
            eventBus.emit('SHOW_MODAL', {
                open: true,
                title: title,
                content: content,
                loading: false
            });
        };

        const App = () => {
            const [db, setDb] = useState([]);
            const [loading, setLoading] = useState(true);
            const [query, setQuery] = useState("");
            const initialFilters = { brand: "All", type: "All", capacity: "All" };
            const [filters, setFilters] = useState(initialFilters);
            
            const [keyModal, setKeyModal] = useState(false); 
            const [cloudModal, setCloudModal] = useState(false);
            const [isCloudImporting, setIsCloudImporting] = useState(false);
            const [searchResults, setSearchResults] = useState(null); 
            
            const [apiKey, setApiKey] = useState("");

            useEffect(() => {
                const init = async () => {
                    const key = IO.get("GEMINI_KEY");
                    if(key) setApiKey(key);

                    const local = IO.get(CFG.LS_KEY);
                    let initialData = [];

                    if(local) {
                        try {
                            const parsed = JSON.parse(local);
                            if(Array.isArray(parsed) && parsed.length) {
                                initialData = parsed.map(IO.enrich).filter(x=>x);
                            }
                        } catch {}
                    }

                    if (initialData.length === 0) {
                        try {
                            const manifestRes = await fetch(CFG.MANIFEST_FILE);
                            if (!manifestRes.ok) throw new Error("Manifest not found");
                            
                            const manifest = await manifestRes.json();
                            const filesToLoad = manifest.files || [];

                            const promises = filesToLoad.map(file => 
                                fetch(file).then(res => res.json())
                            );
                            const results = await Promise.allSettled(promises);
                            const validData = results
                                .filter(r => r.status === 'fulfilled')
                                .map(r => r.value)
                                .flat()
                                .map(IO.enrich)
                                .filter(x => x);

                            if(validData.length > 0) {
                                initialData = validData;
                                IO.set(CFG.LS_KEY, JSON.stringify(validData));
                            }
                        } catch (e) {
                            console.warn("Manifest/Auto-load failed:", e.message);
                        }
                    }

                    setDb(initialData);
                    setLoading(false);
                };
                init();
            }, []);

            useEffect(() => {
                if(db.length > 0) IO.set(CFG.LS_KEY, JSON.stringify(db));
            }, [db]);

            const filteredData = useMemo(() => {
                let res = db;
                if (filters.brand !== "All") res = res.filter(i => i.brand === filters.brand);
                if (filters.type !== "All") res = res.filter(i => i.type === filters.type);
                if (filters.capacity !== "All") res = res.filter(i => i.capacity === filters.capacity);
                if (query.trim()) {
                    const q = query.toLowerCase();
                    res = res.filter(i => 
                        (i.brand || "").toLowerCase().includes(q) || 
                        (i.model || "").toLowerCase().includes(q) || 
                        (i.type || "").includes(q)
                    );
                }
                return res;
            }, [db, filters, query]);

            const options = useMemo(() => ({
                brand: ["All", ...new Set(db.map(i => i.brand))].sort(),
                type: ["All", ...new Set(db.map(i => i.type))].sort(),
                capacity: ["All", ...new Set(db.map(i => i.capacity))].sort()
            }), [db]);

            const handleImport = (newData) => {
                if(!newData || !Array.isArray(newData)) return;
                setDb(prev => {
                    const ids = new Set(prev.map(i => i.id));
                    const unique = newData.filter(i => !ids.has(i.id)).map(IO.enrich).filter(x=>x);
                    if(unique.length === 0) return prev;
                    return [...unique, ...prev];
                });
            };

            const handleFileImport = async (e) => {
                const files = Array.from(e.target.files);
                if(!files.length) return;
                
                const readPromises = files.map(file => new Promise(resolve => {
                    const r = new FileReader();
                    r.onload = evt => {
                        try { resolve(JSON.parse(evt.target.result)); } 
                        catch { resolve([]); }
                    };
                    r.readAsText(file);
                }));

                const flatItems = (await Promise.all(readPromises)).flat().map(IO.enrich).filter(x=>x);
                
                if(flatItems.length > 0) {
                    handleImport(flatItems);
                    alert(`Imported ${flatItems.length} items.`);
                } else {
                    alert("No valid data found.");
                }
                e.target.value = null;
            };

            const showNativeLoading = (title) => {
                const dialog = document.getElementById('native-loading-dialog');
                if (!dialog) return;
                document.getElementById('native-loading-title').textContent = title;
                dialog.showModal();
            };

            const hideNativeLoading = () => {
                const dialog = document.getElementById('native-loading-dialog');
                if (dialog) dialog.close();
            };

            const handleWebSearch = async (e) => {
                if (e) e.preventDefault();
                if(!query.trim()) return; 
                if(!apiKey) return showNativeKeyDialog(handleKeySave);

                const prompt = `Search coffee gear: "${query}". Return JSON ARRAY. Schema: {"brand":"String (TW)","model":"String (TW)","type":"String (TW)","material":"String (TW)","capacity":"String (TW)","feature":"String (TW)","priceLevel":"String ($$$)","verdict":"String (TW)","pros":["String (TW)"],"cons":["String (TW)"],"sentiment":[{"name":"Tag (TW)","value":Number,"color":"String (#hex)"}]}. Return ONLY JSON.`;
                
                showNativeLoading("Searching Web...");
                
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${CFG.API_MODEL}:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], tools: [{"google_search":{}}], systemInstruction: { parts: [{ text: "You are a coffee equipment data generator. You must return the data in the specified JSON schema using Traditional Chinese for all fields except priceLevel and color." }] } })
                    });
                    
                    if (!res.ok) {
                        const errData = await res.json();
                        throw new Error(errData.error?.message || `HTTP ${res.status}`);
                    }
                    
                    const data = await res.json();
                    const jsonStr = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    const parsed = IO.parseJSON(jsonStr);
                    
                    if(!parsed || !Array.isArray(parsed)) throw new Error("Invalid JSON format from AI");

                    const newItems = parsed.map(i => ({...IO.enrich(i), id: IO.genId(db)}));
                    
                    hideNativeLoading(); 
                    setSearchResults(newItems);
                    
                } catch (err) { 
                    hideNativeLoading();
                    alert(`Search Failed: ${err.message}`); 
                }
            };

            const addItemFromSearch = (item) => {
                const newItem = { ...item, id: IO.genId(db) };
                handleImport([newItem]);
                setSearchResults(prev => {
                    const left = prev.filter(i => i !== item);
                    return left.length === 0 ? null : left;
                });
            };

            const handleAI = (mode, item, extra) => {
                if(!apiKey) return showNativeKeyDialog(handleKeySave);
                
                const initialTitle = mode === 'snark' ? `AI æ¯’èˆŒè©•è«–: ${item.model}` : `AI æ²–ç…®å»ºè­°: ${item.model}`;
                
                showNativeLoading(initialTitle);

                setTimeout(async () => {
                    let prompt = "";
                    let systemInstruction = "";
                    let resultText = "";

                    if(mode === 'snark') {
                        prompt = `è«‹ç”¨ç¹é«”ä¸­æ–‡ã€å¹½é»˜æ¯’èˆŒä½†å°ˆæ¥­çš„èªžæ°£è©•è«– ${item.brand} ${item.model}ã€‚æŒ‡å‡ºå®ƒçš„è‡´å‘½ç¼ºé»žï¼Œä¸¦å‘Šè¨´æˆ‘å®ƒé©åˆä»€éº¼æ¨£çš„å—å®³è€…(ä½¿ç”¨è€…)ã€‚`;
                        systemInstruction = "ä½ æ˜¯ä¸€ä½æ¥µåº¦æ¯’èˆŒä¸”å°ˆæ¥­çš„å’–å•¡å™¨æè©•è«–å®¶ï¼Œè«‹ä½¿ç”¨ Markdown æ ¼å¼ï¼Œä¸¦ä¸”å¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚";
                    } else if (mode === 'recipe') {
                        prompt = `é‡å° ${item.brand} ${item.model}ï¼Œæä¾›ä¸€ä»½é©åˆã€Œ${extra}ã€çƒ˜ç„™è±†çš„å…·é«”æ²–ç…®åƒæ•¸ï¼ˆç²‰æ°´æ¯”ã€ç ”ç£¨åº¦ã€æ°´æº«ã€æ³¨æ°´æ‰‹æ³•ï¼‰ã€‚`;
                        systemInstruction = "ä½ æ˜¯ä¸€ä½é ‚å°–çš„å’–å•¡å¸«ï¼Œè«‹ä½¿ç”¨ Markdown è¡¨æ ¼ä¾†å‘ˆç¾æ²–ç…®åƒæ•¸ï¼Œæ‰€æœ‰æ–‡å­—å¿…é ˆæ˜¯ç¹é«”ä¸­æ–‡ã€‚";
                    }
                    
                    try {
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${CFG.API_MODEL}:generateContent?key=${apiKey}`, {
                            method: 'POST', headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ 
                                contents: [{ parts: [{ text: prompt }] }],
                                systemInstruction: { parts: [{ text: systemInstruction }] }
                            })
                        });
                        
                        if (!res.ok) {
                            const errData = await res.json();
                            throw new Error(errData.error?.message || `HTTP ${res.status}`);
                        }
                        
                        const data = await res.json();
                        resultText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                        
                        if (!resultText) throw new Error("Empty AI response");
                        
                    } catch (err) { 
                        resultText = `**AI å‘¼å«å¤±æ•—**\n\néŒ¯èª¤è¨Šæ¯: ${err.message}`;
                    } finally {
                        hideNativeLoading();
                        showNativeResult(initialTitle, resultText);
                    }
                }, 10);
            };
            
            const handleClearFilters = () => {
                setQuery("");
                setFilters(initialFilters);
            };

            const handleReset = () => { if(confirm("ç¢ºå®šè¦é‡ç½®æ•´å€‹è³‡æ–™åº« (Local Storage) å—Žï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŽŸã€‚")) { IO.del(CFG.LS_KEY); window.location.reload(); } };
            const handleExport = () => {
                const blob = new Blob([JSON.stringify(db, null, 2)], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `coffee_geek_backup_v51.0.json`;
                a.click();
            };

            const handleKeySave = (key) => {
                if (key && key.trim().length > 10) { 
                    IO.set("GEMINI_KEY", key);
                    setApiKey(key);
                } else {
                    alert("Invalid API Key.");
                }
            };
            
            if(loading && db.length === 0) return e('div', { className: "min-h-screen bg-[#0c0c0c] flex items-center justify-center" }, e('div', { className: "w-12 h-12 border-4 border-yellow-600 rounded-full spin border-t-transparent" }));

            if (db.length === 0) {
                return e(React.Fragment, null,
                    e(WelcomeScreen, { onFileImport: handleFileImport, onCloudClick: ()=>setCloudModal(true), isCloudImporting: isCloudImporting }),
                    cloudModal && e(CloudImportModal, { 
                        onClose: ()=>setCloudModal(false), 
                        onImport: handleImport, 
                        importing: isCloudImporting,
                        setImporting: setIsCloudImporting
                    })
                );
            }

            return e('div', { className: "min-h-screen bg-[#0c0c0c] pb-8 fade-in text-base" }, 
                e('nav', { className: "sticky top-0 z-40 bg-[#0c0c0c]/90 backdrop-blur border-b border-[#27272a] px-4 py-3 shadow-lg" }, 
                    e('div', { className: "max-w-[1600px] mx-auto flex flex-col md:flex-row items-center justify-between gap-4" }, 
                        e('div', { className: "flex items-center gap-2 flex-shrink-0" }, 
                            e('span', { className: "bg-yellow-500 text-black px-2 py-0.5 rounded font-black text-xs" }, "V51.0"),
                            e('h1', { className: "font-bold text-gray-100 tracking-tight text-lg" }, "COFFEE GEEK")
                        ),
                        e('form', { onSubmit: handleWebSearch, className: "relative w-full max-w-xl group flex gap-2" }, 
                            e('div', { className: "relative flex-1" }, 
                                e('div', { className: "absolute left-3 top-2.5 text-gray-500" }, e(Icon, { n: "search", c: "w-4 h-4" })),
                                e('input', { 
                                    type: "text", 
                                    value: query, 
                                    onChange: e=>setQuery(e.target.value), 
                                    placeholder: "Search gear...", 
                                    className: "w-full bg-[#18181b] border border-[#27272a] text-gray-200 rounded-lg pl-9 pr-4 py-2 focus:border-yellow-600 focus:outline-none transition-all" 
                                })
                            ),
                            e('button', { type: "submit", className: "flex items-center justify-center p-2 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-lg transition", title: "Search Web" }, e(Icon, { n: "search", c: "w-5 h-5" }))
                        ),
                        e('div', { className: "flex items-center gap-2 w-full md:w-auto overflow-x-auto pb-1 md:pb-0" }, 
                            e('select', { className: "bg-[#18181b] border border-[#27272a] text-gray-300 rounded px-2 py-2 cursor-pointer focus:outline-none text-sm", value: filters.brand, onChange: e=>setFilters({...filters, brand: e.target.value}) }, options.brand.map(o=>e('option', { key: o, value: o }, o))),
                            e('select', { className: "bg-[#18181b] border border-[#27272a] text-gray-300 rounded px-2 py-2 cursor-pointer focus:outline-none text-sm", value: filters.type, onChange: e=>setFilters({...filters, type: e.target.value}) }, options.type.map(o=>e('option', { key: o, value: o }, o))),
                            e('button', { onClick: handleClearFilters, className: "p-2 rounded border border-red-900 text-red-400 bg-red-900/10 hover:bg-red-900/20 transition", title: "Clear Filters" }, e(Icon, { n: "refresh" })),
                            e('button', { onClick: ()=>showNativeKeyDialog(handleKeySave), className: `p-2 rounded border transition ${apiKey ? 'border-green-900 text-green-500 bg-green-900/10' : 'border-[#27272a] text-gray-400 bg-[#18181b] hover:text-white'}`, title: "API Settings" }, e(Icon, { n: "settings" }))
                        )
                    )
                ),
                e('main', { className: "max-w-[1600px] mx-auto p-4" }, 
                    e('div', { className: "top-tools-container max-w-[1600px] mx-auto px-1 flex justify-between items-center text-base text-gray-500" }, 
                        e('div', { className: "flex gap-3" }, 
                            e('button', { onClick: handleReset, className: "hover:text-red-500 flex items-center gap-1 transition text-sm" }, e(Icon, { n: "trash" }), " RESET"),
                            e('button', { onClick: ()=>setCloudModal(true), className: "hover:text-blue-500 flex items-center gap-1 transition text-sm" }, e(Icon, { n: "cloud" }), " CLOUD")
                        ),
                        e('div', { className: "flex items-center gap-3" }, 
                            e('button', { onClick: handleExport, className: "hover:text-blue-400 flex items-center gap-1 transition text-sm" }, e(Icon, { n: "download" }), " BACKUP"),
                            e('label', { className: "hover:text-green-400 flex items-center gap-1 cursor-pointer transition text-sm" }, e(Icon, { n: "upload" }), " FILE", e('input', { type: "file", multiple: true, accept: ".json", className: "hidden", onChange: handleFileImport }))
                        )
                    ),
                    e('div', { className: "flex justify-between items-end mb-4 px-1" }, 
                        e('p', { className: "text-gray-500 text-xs font-mono" }, "ITEMS: ", e('span', { className: "text-yellow-500" }, filteredData.length))
                    ),
                    filteredData.length > 0 
                        ? e('div', { className: "tetris-grid" }, filteredData.map(item => e(Card, { key: item.id, item: item, spanClass: IO.getSpanClass(item), onAI: handleAI })))
                        : e('div', { className: "flex flex-col items-center justify-center py-20 text-gray-600 border-2 border-dashed border-[#27272a] rounded-xl" },
                            e(Icon, { n: "cloud", c: "w-12 h-12 mb-4 opacity-20" }),
                            e('p', { className: "text-lg font-bold text-gray-500 mb-4" }, "NO LOCAL DATA FOUND"),
                            e('button', {
                                onClick: handleWebSearch,
                                className: "px-6 py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-lg shadow-lg transition flex items-center gap-2"
                            }, e(Icon, { n: "search", c: "w-5 h-5" }), ` Search Web for "${query}"`)
                        )
                ),
                e(GlobalModal),
                cloudModal && e(CloudImportModal, { 
                    onClose: ()=>setCloudModal(false), 
                    onImport: handleImport, 
                    importing: isCloudImporting,
                    setImporting: setIsCloudImporting
                }),
                searchResults && e(SearchResultModal, { results: searchResults, onClose: ()=>setSearchResults(null), onAdd: addItemFromSearch })
            );
        };
        
        const WelcomeScreen = ({ onFileImport, onCloudClick, isCloudImporting }) => (
            e('div', { className: "min-h-screen flex flex-col items-center justify-center p-6 bg-[#0c0c0c] text-center space-y-10 fade-in" }, 
                e('div', { className: "space-y-4" }, 
                    e('div', { className: "w-24 h-24 bg-gradient-to-br from-yellow-600 to-yellow-800 rounded-full flex items-center justify-center mx-auto border-4 border-[#27272a] shadow-2xl" }, 
                        e(Icon, { n: "chef", c: "w-12 h-12 text-white" })
                    ),
                    e('h1', { className: "text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-500" }, "COFFEE GEEK"),
                    e('p', { className: "text-gray-400 tracking-[0.3em] text-xs uppercase" }, "Equipment Database Manager")
                ),
                e('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-3xl" }, 
                    e('label', { className: "group cursor-pointer bg-[#18181b] border border-[#27272a] p-8 rounded-2xl hover:border-yellow-600/50 hover:bg-[#1f1f22] transition-all duration-300 flex flex-col items-center gap-4 shadow-lg" }, 
                        e('div', { className: "p-4 bg-[#27272a] rounded-full group-hover:bg-yellow-900/20 transition-colors" }, e(Icon, { n: "upload", c: "w-8 h-8 text-yellow-500" })),
                        e('div', null, 
                            e('h3', { className: "text-xl font-bold text-white mb-1" }, "Import Local JSON"),
                            e('p', { className: "text-xs text-gray-500" }, "Select multiple files")
                        ),
                        e('input', { type: "file", multiple: true, accept: ".json", className: "hidden", onChange: handleFileImport })
                    ),
                    e('button', { onClick: onCloudClick, disabled: isCloudImporting, className: "group cursor-pointer bg-[#18181b] border border-[#27272a] p-8 rounded-2xl hover:border-blue-600/50 hover:bg-[#1f1f22] transition-all duration-300 flex flex-col items-center gap-4 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:border-[#27272a] disabled:hover:bg-[#18181b]" }, 
                        e('div', { className: "p-4 bg-[#27272a] rounded-full group-hover:bg-blue-900/20 transition-colors" }, 
                            e(Icon, { n: "cloud", c: `w-8 h-8 text-blue-500 ${isCloudImporting ? 'spin' : ''}` })
                        ),
                        e('div', null, 
                            e('h3', { className: "text-xl font-bold text-white mb-1" }, "Import from Cloud"),
                            e('p', { className: "text-xs text-gray-500" }, "Load from URL")
                        )
                    )
                ),
                e('div', { className: "text-xs text-gray-600 font-mono pt-10" }, "v51.0 | PURE JS FIX")
            )
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(e(App));
    </script>
</body>
</html>