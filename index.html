<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coffee Geek Finder v23 | Import Logic Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        body { background-color: #0c0c0c; color: #e5e5e5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", sans-serif; overflow-x: hidden; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0c0c0c; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .spin-slow { animation: spin 2s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .tetris-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            grid-auto-rows: auto; 
            grid-auto-flow: dense; 
            gap: 1.5rem; 
        }

        .mkd h1, .mkd h2 { color: #facc15; font-weight: 700; margin-top: 1em; margin-bottom: 0.5em; border-bottom: 1px solid #333; padding-bottom: 0.3em; }
        .mkd ul { list-style: disc; padding-left: 1.5em; color: #a8a29e; margin-bottom: 1em; }
        .mkd li { margin-bottom: 0.2em; }
        .mkd strong { color: #fff; font-weight: 600; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        const CFG = {
            LS_KEY: "CGF_DB_V23_FIX",
            DEFAULT_FILES: ["./db_grinders.json", "./db_brewers.json", "./db_misc.json"]
        };

        const IO = {
            get: (k) => { try { return localStorage.getItem(k) } catch { return null } },
            set: (k, v) => { try { localStorage.setItem(k, v) } catch {} },
            del: (k) => { try { localStorage.removeItem(k) } catch {} },
            genId: (list) => (list.reduce((m, i) => Math.max(m, parseInt(i.id) || 0), 0) + 1),
            enrich: (p) => {
                if(!p.sentiment || !Array.isArray(p.sentiment)) p.sentiment = [{name:"Êú™Áü•", value:100, color:"#555"}];
                return p;
            },
            transformUrl: (url) => {
                const driveRegex = /\/file\/d\/([a-zA-Z0-9_-]+)\//;
                const match = url.match(driveRegex);
                if (match && match[1]) {
                    return `https://api.allorigins.win/raw?url=${encodeURIComponent(`https://drive.google.com/uc?export=download&id=${match[1]}`)}`;
                }
                return url;
            }
        };

        // --- Logic: Visual Weight Calculation ---
        const getSpanClass = (item) => {
            let score = 0;
            const pros = item.pros || [];
            const cons = item.cons || [];
            if (pros.length + cons.length >= 5) score += 2;
            if (item.priceLevel === "$$$$$") score += 2;
            else if (item.priceLevel === "$$$$") score += 1;
            if ((item.verdict || "").length > 30) score += 1;
            
            if (score >= 4) return "col-span-1 md:col-span-2 row-span-2"; 
            if (score === 3) return (parseInt(item.id)||0)%2===0 ? "col-span-1 md:col-span-2" : "col-span-1 row-span-2";
            return "col-span-1";
        };

        const Icons = {
            Search: () => <path d="m21 21-4.3-4.3M11 19a8 8 0 1 0 0-16 8 8 0 0 0 0 16z"/>,
            Cloud: () => <path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/>,
            Upload: () => <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>,
            Settings: () => <path d="M12.22 2h-.44a2 2 0 0 1-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z M12 9a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/>,
            Plus: () => <path d="M12 5v14M5 12h14"/>,
            Trash: () => <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>,
            Download: () => <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>,
            Msg: () => <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>,
            Chef: () => <path d="M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 9.08 0A5.11 5.11 0 0 1 18.59 6 4 4 0 0 1 20 13.87V21H6Z M6 17h14"/>,
            Refresh: () => <path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16"/>,
            Scale: () => <path d="M6 20h12a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2z M12 14v4 M12 2v4"/>,
            Tag: () => <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z M7 7h.01"/>
        };
        const Ico = ({n, c=""}) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={c}>{Icons[n]()}</svg>;

        const PieChart = React.memo(({ data }) => {
            if(!data || !data.length) return null;
            const total = data.reduce((s, i) => s + i.value, 0);
            const items = data.map(i => ({...i, percent: i.value / total}));
            let cumulativePercent = 0;
            const getCoords = (pct) => [Math.cos(2*Math.PI*pct), Math.sin(2*Math.PI*pct)];
            return (
                <svg viewBox="-1.1 -1.1 2.2 2.2" className="w-full h-full -rotate-90">
                    {items.map((slice, i) => {
                        const start = cumulativePercent;
                        const end = start + slice.percent;
                        cumulativePercent = end;
                        const [sx, sy] = getCoords(start);
                        const [ex, ey] = getCoords(end);
                        const large = slice.percent > 0.5 ? 1 : 0;
                        const d = `M ${sx} ${sy} A 1 1 0 ${large} 1 ${ex} ${ey} L ${ex*0.65} ${ey*0.65} A 0.65 0.65 0 ${large} 0 ${sx*0.65} ${sy*0.65} Z`;
                        return <path key={i} d={d} fill={slice.color} stroke="#18181b" strokeWidth="0.02" className="hover:opacity-80 transition"/>;
                    })}
                </svg>
            );
        });

        const getFeatureLabel = (type) => {
            if(type.includes("Á£®")) return "ÂàÄÁõ§";
            if(type.includes("Êøæ") || type.includes("Â£∫")) return "ÁµêÊßã";
            if(type.includes("Áß§")) return "ÁâπÊÄß";
            if(type.includes("Â£ì")) return "Ê©üÂà∂";
            return "ÁâπÈªû";
        };

        const Card = React.memo(({ item, spanClass, onAI }) => {
            const [menuOpen, setMenuOpen] = useState(false);
            const isHuge = spanClass.includes('row-span-2') && spanClass.includes('col-span-2');
            const isBig = spanClass.includes('row-span-2') || spanClass.includes('col-span-2');
            
            const typo = {
                brand: isHuge ? "text-sm font-black tracking-[0.2em]" : (isBig ? "text-xs font-bold tracking-widest" : "text-[10px] font-bold tracking-widest"),
                title: isHuge ? "text-4xl md:text-5xl mt-2 mb-3" : (isBig ? "text-2xl mt-1 mb-2" : "text-lg"),
                verdict: isHuge ? "text-base" : (isBig ? "text-sm" : "text-xs"),
                listTitle: isHuge ? "text-sm mb-2" : "text-[10px] mb-1",
                listText: isHuge ? "text-sm" : "text-[10px]",
                btn: isHuge ? "text-xs py-2" : "text-[10px] py-1.5",
                feat: isHuge ? "text-lg" : "text-xs",
                featLabel: isHuge ? "text-xs" : "text-[10px]"
            };

            const searchUrl = (type) => {
                const q = encodeURIComponent(`${item.brand} ${item.model}`);
                return type === 'shopee' ? `https://shopee.tw/search?keyword=${q}` : `https://www.momoshop.com.tw/search/searchShop.jsp?keyword=${q}`;
            };

            return (
                <div className={`bg-[#18181b] border border-[#27272a] rounded-xl p-5 flex flex-col gap-3 group hover:border-yellow-600/50 hover:shadow-2xl transition-all duration-300 relative h-full ${spanClass}`}>
                    <div className="flex justify-between items-start">
                        <div className="min-w-0 pr-2 w-full">
                            <span className={`text-yellow-500 uppercase block truncate ${typo.brand}`}>{item.brand}</span>
                            <h3 className={`font-bold text-gray-100 leading-none truncate ${typo.title}`}>{item.model}</h3>
                            <div className="flex gap-2 mt-2">
                                <span className="flex items-center gap-1 bg-[#27272a] text-gray-400 px-2 py-1 rounded border border-[#3f3f46] text-[10px]">
                                    <Ico n="Tag" c="w-3 h-3"/> {item.type}
                                </span>
                                <span className="flex items-center gap-1 bg-[#27272a] text-gray-400 px-2 py-1 rounded border border-[#3f3f46] text-[10px]">
                                    <Ico n="Scale" c="w-3 h-3"/> {item.capacity}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div className="bg-[#27272a]/50 p-3 rounded border-l-4 border-yellow-600 flex flex-col gap-1">
                        <div className="flex justify-between items-center text-[10px] font-bold tracking-wider text-gray-500 mb-1">
                            <span>GEEK VERDICT</span>
                            <span className="text-yellow-500 font-mono text-sm">{item.priceLevel}</span>
                        </div>
                        <p className={`text-gray-300 italic leading-relaxed ${typo.verdict}`}>"{item.verdict || 'Êö´ÁÑ°Ë©ïÂÉπ'}"</p>
                    </div>
                    <div className={`grid grid-cols-2 gap-4 flex-grow ${isBig ? 'overflow-auto' : 'overflow-hidden'}`}>
                        <div>
                            <span className={`text-emerald-500 font-bold block tracking-wide flex items-center gap-1 ${typo.listTitle}`}>
                                <span>üëç</span> PROS
                            </span>
                            <ul className={`space-y-1 text-gray-400 ${typo.listText}`}>
                                {(item.pros||[]).slice(0, isHuge ? 8 : (isBig ? 5 : 3)).map((p,i)=><li key={i} className="flex items-start"><span className="mr-1.5 text-emerald-500/50">‚Ä¢</span><span className={isHuge?'':'truncate'}>{p}</span></li>)}
                            </ul>
                        </div>
                        <div>
                            <span className={`text-rose-500 font-bold block tracking-wide flex items-center gap-1 ${typo.listTitle}`}>
                                <span>üëé</span> CONS
                            </span>
                            <ul className={`space-y-1 text-gray-400 ${typo.listText}`}>
                                {(item.cons||[]).slice(0, isHuge ? 8 : (isBig ? 5 : 3)).map((c,i)=><li key={i} className="flex items-start"><span className="mr-1.5 text-rose-500/50">‚Ä¢</span><span className={isHuge?'':'truncate'}>{c}</span></li>)}
                            </ul>
                        </div>
                    </div>
                    <div className="flex items-center justify-between border-t border-[#27272a] pt-3 mt-auto">
                        <div className={`${isHuge ? 'w-16 h-16' : 'w-12 h-12'} relative flex-shrink-0 mr-4`}>
                            <PieChart data={item.sentiment} />
                        </div>
                        <div className="flex flex-col items-end">
                            <span className={`text-gray-500 uppercase font-bold ${typo.featLabel}`}>{getFeatureLabel(item.type)}</span>
                            <span className={`text-gray-200 font-mono border border-[#3f3f46] bg-[#27272a] px-2 py-0.5 rounded ${typo.feat}`}>{item.feature}</span>
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-2 mt-2">
                        <button onClick={()=>onAI('snark', item)} className={`flex items-center justify-center gap-1 bg-indigo-900/20 text-indigo-300 border border-indigo-500/30 rounded hover:bg-indigo-900/40 transition ${typo.btn}`}>
                            <Ico n="Msg" c="w-3 h-3"/> {isHuge ? 'AI ÊØíËàå' : 'ÊØíËàå'}
                        </button>
                        <div className="relative">
                            <button onClick={()=>setMenuOpen(!menuOpen)} className={`w-full flex items-center justify-center gap-1 bg-emerald-900/20 text-emerald-300 border border-emerald-500/30 rounded hover:bg-emerald-900/40 transition ${typo.btn}`}>
                                <Ico n="Chef" c="w-3 h-3"/> {isHuge ? 'AI ÂèÉÊï∏' : 'ÂèÉÊï∏'}
                            </button>
                            {menuOpen && (
                                <div className="absolute bottom-full left-0 w-full mb-1 bg-[#27272a] border border-[#3f3f46] rounded shadow-xl z-20 flex flex-col overflow-hidden">
                                    {['Ê∑∫ÁÑô','‰∏≠ÁÑô','Ê∑±ÁÑô'].map(r => (
                                        <button key={r} onClick={()=>{onAI('recipe', item, r); setMenuOpen(false)}} className="px-3 py-2 text-left text-xs text-gray-300 hover:bg-[#3f3f46] hover:text-white transition">{r}</button>
                                    ))}
                                </div>
                            )}
                        </div>
                        <a href={searchUrl('shopee')} target="_blank" className={`flex items-center justify-center gap-1 bg-[#ee4d2d] text-white font-bold rounded hover:opacity-90 transition ${typo.btn}`}>Ëù¶ÁöÆ</a>
                        <a href={searchUrl('momo')} target="_blank" className={`flex items-center justify-center gap-1 bg-[#d63086] text-white font-bold rounded hover:opacity-90 transition ${typo.btn}`}>MOMO</a>
                    </div>
                </div>
            );
        });

        const CloudImportModal = ({ onClose, onImport }) => {
            const [url, setUrl] = useState("");
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState("");

            const handleImport = async () => {
                if (!url.trim()) return;
                setLoading(true);
                setError("");
                const fetchUrl = IO.transformUrl(url.trim());
                try {
                    const res = await fetch(fetchUrl);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const json = await res.json();
                    const data = Array.isArray(json) ? json : [json];
                    if (data.length === 0) throw new Error("Empty JSON");
                    onImport(data);
                    onClose();
                } catch (err) {
                    setError("ÁÑ°Ê≥ïËÆÄÂèñ„ÄÇË´ãÁ¢∫Ë™çÈÄ£ÁµêÊ¨äÈôêÂÖ¨ÈñãÔºå‰∏îÊ™îÊ°àÁÇ∫ JSON Ê†ºÂºè„ÄÇ");
                } finally { setLoading(false); }
            };

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4" onClick={onClose}>
                    <div className="bg-[#18181b] border border-[#27272a] rounded-xl p-6 w-full max-w-md shadow-2xl" onClick={e=>e.stopPropagation()}>
                        <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2"><Ico n="Cloud" c="w-5 h-5 text-blue-500"/> Èõ≤Á´ØÂåØÂÖ•</h3>
                        <input type="text" value={url} onChange={e=>setUrl(e.target.value)} placeholder="Google Drive / GitHub Raw URL..." className="w-full bg-black border border-[#3f3f46] rounded p-3 text-white text-sm mb-2 focus:border-blue-500 focus:outline-none"/>
                        {error && <p className="text-red-400 text-xs mb-4">{error}</p>}
                        <div className="flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 text-gray-400 hover:text-white text-sm">ÂèñÊ∂à</button>
                            <button onClick={handleImport} disabled={loading} className="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded text-sm transition flex items-center gap-2">
                                {loading && <Ico n="Refresh" c="w-4 h-4 spin-slow"/>} ËºâÂÖ•
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [db, setDb] = useState([]);
            const [filteredData, setFilteredData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [query, setQuery] = useState("");
            const [filters, setFilters] = useState({ brand: "All", type: "All", capacity: "All" });
            const [modal, setModal] = useState({ open: false, title: "", content: "", loading: false });
            const [keyModal, setKeyModal] = useState(false);
            const [cloudModal, setCloudModal] = useState(false);
            const [apiKey, setApiKey] = useState("");

            useEffect(() => {
                const init = async () => {
                    const savedKey = IO.get("GEMINI_KEY");
                    if(savedKey) setApiKey(savedKey);
                    const savedDB = IO.get(CFG.LS_KEY);
                    if(savedDB) {
                        try {
                            const parsed = JSON.parse(savedDB);
                            if(Array.isArray(parsed) && parsed.length) {
                                setDb(parsed.map(IO.enrich));
                                setLoading(false);
                                return;
                            }
                        } catch {}
                    }
                    try {
                        const fetches = CFG.DEFAULT_FILES.map(f => fetch(f).then(r => r.ok ? r.json() : []));
                        const results = await Promise.all(fetches);
                        const merged = results.flat().map(IO.enrich);
                        if(merged.length) {
                            setDb(merged);
                            IO.set(CFG.LS_KEY, JSON.stringify(merged));
                        }
                    } catch(e) { console.error(e); }
                    setLoading(false);
                };
                init();
            }, []);

            useEffect(() => {
                let res = db;
                if(filters.brand !== "All") res = res.filter(i => i.brand === filters.brand);
                if(filters.type !== "All") res = res.filter(i => i.type === filters.type);
                if(filters.capacity !== "All") res = res.filter(i => i.capacity === filters.capacity);
                if(query) {
                    const q = query.toLowerCase();
                    res = res.filter(i => 
                        i.brand.toLowerCase().includes(q) || 
                        i.model.toLowerCase().includes(q) || 
                        i.type.includes(q)
                    );
                }
                setFilteredData(res);
            }, [db, filters, query]);

            const options = useMemo(() => ({
                brand: ["All", ...new Set(db.map(i => i.brand))].sort(),
                type: ["All", ...new Set(db.map(i => i.type))].sort(),
                capacity: ["All", ...new Set(db.map(i => i.capacity))].sort()
            }), [db]);

            const handleAI = async (mode, item, extra) => {
                if(!apiKey) return setKeyModal(true);
                setModal({ open: true, title: `${item.brand} ${item.model}`, content: "", loading: true });
                let prompt = "";
                if(mode === 'snark') prompt = `‰Ω†ÊòØÂíñÂï°Â∞àÂÆ∂„ÄÇË´ãÁî®ÁπÅÈ´î‰∏≠Êñá„ÄÅÂπΩÈªòÊØíËàåË™ûÊ∞£Ë©ïË´ñ ${item.brand} ${item.model}„ÄÇMarkdown„ÄÇ`;
                else if (mode === 'recipe') prompt = `ÈáùÂ∞ç ${item.brand} ${item.model} Êèê‰æõ„Äå${extra}„ÄçË±ÜÂ≠êÂèÉÊï∏„ÄÇË°®Ê†º„ÄÇÁπÅÈ´î‰∏≠Êñá„ÄÇ`;
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await res.json();
                    setModal(prev => ({...prev, content: data.candidates?.[0]?.content?.parts?.[0]?.text || "Error", loading: false}));
                } catch { setModal(prev => ({...prev, content: "Conn Err", loading: false})); }
            };

            const handleAddSearch = async (e) => {
                e.preventDefault();
                if(!query.trim() || !apiKey) return setKeyModal(true);
                if(!confirm(`AI ÊêúÂ∞ã "${query}"?`)) return;
                setModal({ open: true, title: "AI Search...", content: "", loading: true });
                const prompt = `Search coffee gear: "${query}". Return JSON ARRAY. Schema: {"brand":"","model":"","type":"(TW)","material":"","capacity":"","feature":"","priceLevel":"$","verdict":"(TW)","pros":[""],"cons":[""],"sentiment":[{"name":"Tag","value":80,"color":"#4ade80"}]}`;
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
                    });
                    const data = await res.json();
                    const newItems = JSON.parse(data.candidates?.[0]?.content?.parts?.[0]?.text).map(i => ({...IO.enrich(i), id: IO.genId(db)}));
                    const merged = [...newItems, ...db];
                    setDb(merged);
                    IO.set(CFG.LS_KEY, JSON.stringify(merged));
                    setModal({ open: false, title: "", content: "", loading: false });
                    setQuery("");
                    alert(`Added ${newItems.length} items`);
                } catch { setModal(prev => ({...prev, content: "Search Failed", loading: false})); }
            };

            const handleImport = (newData) => {
                let newDb = [...db];
                const ids = new Set(newDb.map(i=>i.id));
                const unique = newData.filter(i=>!ids.has(i.id)).map(IO.enrich);
                if(unique.length === 0) return alert("No new data");
                newDb = [...unique, ...newDb];
                setDb(newDb);
                IO.set(CFG.LS_KEY, JSON.stringify(newDb));
                alert(`Imported ${unique.length}`);
            };

            // FIX: Use Promise.all to read files in parallel and import ONCE
            const handleFileImport = async (e) => {
                const files = Array.from(e.target.files);
                if(!files.length) return;
                
                const readFile = (file) => new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        try {
                            const json = JSON.parse(evt.target.result);
                            resolve(Array.isArray(json) ? json : [json]);
                        } catch { resolve([]); }
                    };
                    reader.readAsText(file);
                });

                const results = await Promise.all(files.map(readFile));
                const combinedData = results.flat();
                
                if(combinedData.length > 0) handleImport(combinedData);
                e.target.value = null; // Reset input
            };

            const handleReset = () => { if(confirm("Reset all?")) { IO.del(CFG.LS_KEY); window.location.reload(); } };
            const handleExport = () => {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([JSON.stringify(db, null, 2)], {type: "application/json"}));
                a.download = `coffee_gear_db.json`;
                a.click();
            };

            if(loading && db.length === 0) return <div className="min-h-screen bg-[#0c0c0c] flex items-center justify-center"><div className="w-12 h-12 border-4 border-yellow-600 rounded-full spin-slow border-t-transparent"></div></div>;

            return (
                <div className="min-h-screen bg-[#0c0c0c] pb-20 fade-in text-sm">
                    <nav className="sticky top-0 z-40 bg-[#0c0c0c]/90 backdrop-blur border-b border-[#27272a] px-4 py-3">
                        <div className="max-w-[1600px] mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
                            <div className="flex items-center gap-2 flex-shrink-0">
                                <span className="bg-yellow-500 text-black px-2 py-0.5 rounded font-black text-xs">V23</span>
                                <h1 className="font-bold text-gray-100 tracking-tight">COFFEE GEEK</h1>
                            </div>
                            <form onSubmit={handleAddSearch} className="relative w-full max-w-xl group">
                                <div className="absolute left-3 top-2.5 text-gray-500"><Ico n="Search" c="w-4 h-4"/></div>
                                <input type="text" value={query} onChange={e=>setQuery(e.target.value)} placeholder="Search gear..." className="w-full bg-[#18181b] border border-[#27272a] text-gray-200 rounded-lg pl-9 pr-10 py-2 focus:border-yellow-600 focus:outline-none transition-all" />
                                <button type="submit" className="absolute right-2 top-1.5 p-1 text-gray-500 hover:text-yellow-500"><Ico n="Plus" c="w-4 h-4"/></button>
                            </form>
                            <div className="flex items-center gap-2 w-full md:w-auto overflow-x-auto pb-1 md:pb-0">
                                <select className="bg-[#18181b] border border-[#27272a] text-gray-300 rounded px-2 py-2 cursor-pointer focus:outline-none" value={filters.brand} onChange={e=>setFilters({...filters, brand: e.target.value})}>{options.brand.map(o=><option key={o} value={o}>{o}</option>)}</select>
                                <select className="bg-[#18181b] border border-[#27272a] text-gray-300 rounded px-2 py-2 cursor-pointer focus:outline-none" value={filters.type} onChange={e=>setFilters({...filters, type: e.target.value})}>{options.type.map(o=><option key={o} value={o}>{o}</option>)}</select>
                                <button onClick={()=>setKeyModal(true)} className={`p-2 rounded border transition ${apiKey ? 'border-green-900 text-green-500 bg-green-900/10' : 'border-[#27272a] text-gray-400 bg-[#18181b] hover:text-white'}`}><Ico n="Settings" c="w-4 h-4"/></button>
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-[1600px] mx-auto p-4">
                        <div className="flex justify-between items-end mb-4 px-1">
                            <p className="text-gray-500 text-xs font-mono">ITEMS: <span className="text-yellow-500">{filteredData.length}</span></p>
                        </div>
                        {filteredData.length > 0 ? (
                            <div className="tetris-grid">
                                {filteredData.map(item => <Card key={item.id} item={item} spanClass={getSpanClass(item)} onAI={handleAI} />)}
                            </div>
                        ) : (
                            <div className="flex flex-col items-center justify-center py-20 text-gray-600 border-2 border-dashed border-[#27272a] rounded-xl">
                                <Ico n="Cloud" c="w-12 h-12 mb-4 opacity-20"/>
                                <p className="text-lg font-bold text-gray-500">NO DATA</p>
                                <div className="flex gap-4 mt-6">
                                    <label className="cursor-pointer text-yellow-600 hover:text-yellow-500 flex items-center gap-1 px-4 py-2 border border-yellow-900/30 rounded bg-yellow-900/10 hover:bg-yellow-900/20 transition"><Ico n="Upload" c="w-4 h-4"/> FILE<input type="file" multiple accept=".json" className="hidden" onChange={handleFileImport}/></label>
                                    <button onClick={()=>setCloudModal(true)} className="text-blue-500 hover:text-blue-400 flex items-center gap-1 px-4 py-2 border border-blue-900/30 rounded bg-blue-900/10 hover:bg-blue-900/20 transition"><Ico n="Cloud" c="w-4 h-4"/> CLOUD</button>
                                </div>
                            </div>
                        )}
                    </main>

                    <footer className="fixed bottom-0 left-0 w-full bg-[#0c0c0c] border-t border-[#27272a] py-3 px-6 z-30 flex justify-between items-center text-xs text-gray-500">
                        <div className="flex gap-3">
                            <button onClick={handleReset} className="hover:text-red-500 flex items-center gap-1 transition"><Ico n="Trash" c="w-3 h-3"/> RESET</button>
                            <button onClick={()=>setCloudModal(true)} className="hover:text-blue-500 flex items-center gap-1 transition"><Ico n="Cloud" c="w-3 h-3"/> URL IMPORT</button>
                        </div>
                        <div className="flex items-center gap-3">
                            <button onClick={handleExport} className="hover:text-blue-400 flex items-center gap-1 transition"><Ico n="Download" c="w-3 h-3"/> BACKUP</button>
                            <label className="hover:text-green-400 flex items-center gap-1 cursor-pointer transition"><Ico n="Upload" c="w-3 h-3"/> RESTORE<input type="file" multiple accept=".json" className="hidden" onChange={handleFileImport}/></label>
                        </div>
                    </footer>

                    {keyModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4" onClick={()=>setKeyModal(false)}>
                            <div className="bg-[#18181b] border border-[#27272a] rounded-xl p-6 w-full max-w-sm shadow-2xl" onClick={e=>e.stopPropagation()}>
                                <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2"><Ico n="Settings" c="w-5 h-5"/> API SETUP</h3>
                                <input type="password" value={apiKey} onChange={e=>setApiKey(e.target.value)} placeholder="Paste Gemini API Key..." className="w-full bg-black border border-[#3f3f46] rounded p-3 text-white mb-4 focus:border-yellow-600 focus:outline-none"/>
                                <div className="flex justify-end gap-2">
                                    <button onClick={()=>{IO.set("GEMINI_KEY", apiKey); setKeyModal(false)}} className="px-4 py-2 bg-yellow-600 hover:bg-yellow-500 text-black font-bold rounded transition">SAVE</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {cloudModal && <CloudImportModal onClose={()=>setCloudModal(false)} onImport={handleImport} />}

                    {modal.open && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4" onClick={()=>!modal.loading && setModal({...modal, open:false})}>
                            <div className="bg-[#18181b] border border-[#27272a] rounded-xl w-full max-w-2xl max-h-[80vh] flex flex-col shadow-2xl overflow-hidden" onClick={e=>e.stopPropagation()}>
                                <div className="p-4 border-b border-[#27272a] bg-[#0c0c0c] flex justify-between items-center shrink-0">
                                    <h3 className="font-bold text-yellow-500 flex items-center gap-2"><Ico n={modal.loading?"Refresh":"Cloud"} c={`w-5 h-5 ${modal.loading?'spin-slow':''}`}/> {modal.title || "AI Response"}</h3>
                                    {!modal.loading && <button onClick={()=>setModal({...modal, open:false})} className="text-gray-500 hover:text-white text-xl">&times;</button>}
                                </div>
                                <div className="p-6 overflow-y-auto text-gray-300 mkd">
                                    {modal.loading ? <div className="flex flex-col items-center py-10 gap-4 opacity-50"><div className="w-10 h-10 border-2 border-yellow-600 border-t-transparent rounded-full spin-slow"></div><p className="font-mono text-xs">PROCESSING...</p></div> : <div dangerouslySetInnerHTML={{__html: marked.parse(modal.content||"")}} />}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>