<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coffee Geek Finder v47 | 純資料瀏覽器</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { background-color: #0c0c0c; color: #e5e5e5; font-family: system-ui, -apple-system, sans-serif; overflow-x: hidden; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0c0c0c; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .tetris-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            grid-auto-flow: dense; 
            gap: 1.5rem; 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;

        const CONSTANTS = {
            LS_KEY: "CGF_DB_V47_PURE",
            CONFIG_FILE: "./project_config.json",
            DEFAULT_MANIFEST: "./db_manifest.json"
        };

        const Utils = {
            getLS: (k) => { try { return localStorage.getItem(k); } catch { return null; } },
            setLS: (k, v) => { try { localStorage.setItem(k, v); return true; } catch { return false; } },
            delLS: (k) => { try { localStorage.removeItem(k); } catch {} },
            genId: () => Date.now() + Math.floor(Math.random() * 1000000),

            // 超防禦性淨化函數，取代單純的 trim()
            superTrim: (str) => String(str || '').replace(/\s/g, '').trim(),

            enrich: (raw) => ({
                id: raw.id || Utils.genId(),
                // 確保品牌和類型字串被淨化 (trim) - 這是資料準備階段的關鍵
                brand: String(raw.brand || "Unknown").trim(),
                model: String(raw.model || "Unknown Model"),
                type: String(raw.type || "Equipment").trim(),
                priceLevel: String(raw.priceLevel || "$"),
                capacity: String(raw.capacity || "N/A"),
                feature: String(raw.feature || ""),
                pros: Array.isArray(raw.pros) ? raw.pros : [],
                cons: Array.isArray(raw.cons) ? raw.cons : [],
                sentiment: Array.isArray(raw.sentiment) ? raw.sentiment : [{ name: "N/A", value: 100, color: "#555" }],
                verdict: raw.verdict || "No verdict available."
            }),

            parseJSON: (text) => {
                if (!text) return null;
                try {
                    const parsed = JSON.parse(text.replace(/```json|```/g, '').trim());
                    return Array.isArray(parsed) ? parsed : [parsed];
                } catch (e) {
                    console.error("JSON Parse Error:", e);
                    return null;
                }
            },

            getSpanClass: (item) => {
                let score = 0;
                if ((item.pros?.length || 0) + (item.cons?.length || 0) >= 5) score += 2;
                if (item.priceLevel === "$$$$$") score += 2;
                if ((item.verdict || "").length > 25) score += 1;
                const pseudoRandom = (item.id % 3); 
                if (score >= 4) return "col-span-1 md:col-span-2 row-span-2"; 
                if (score === 3) return pseudoRandom === 0 ? "col-span-1 md:col-span-2 row-span-1" : "col-span-1 row-span-2";
                return "col-span-1 row-span-1";
            },

            proxyUrl: (url) => {
                const match = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)\//);
                return match ? `https://api.allorigins.win/raw?url=${encodeURIComponent(`https://drive.google.com/uc?export=download&id=${match[1]}`)}` : url;
            }
        };

        const Icon = ({ n, c = "w-4 h-4" }) => {
            const paths = {
                search: "m21 21-4.3-4.3M11 19a8 8 0 1 0 0-16 8 8 0 0 0 0 16z",
                cloud: "M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242",
                upload: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12",
                trash: "M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",
                download: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3",
                chef: "M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 9.08 0A5.11 5.11 0 0 1 18.59 6 4 4 0 0 1 20 13.87V21H6Z M6 17h14",
                scale: "M6 20h12a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2z M12 14v4 M12 2v4",
                tag: "M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z M7 7h.01",
                image: "M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z M12 17a4 4 0 1 0 0-8 4 4 0 0 0 0 8z",
                up: "M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3",
                down: "M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2h-3",
                refresh: "M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16",
                close: "M18 6 6 18 M6 6 18 18"
            };
            return <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={c}><path d={paths[n] || ""}/></svg>;
        };

        const PieChart = React.memo(({ data }) => {
            if(!data || !data.length) return null;
            const total = data.reduce((s, i) => s + (i.value || 0), 0);
            let cumulativePercent = 0;
            
            return (
                <svg viewBox="-1.1 -1.1 2.2 2.2" className="w-full h-full -rotate-90">
                    {data.map((slice, i) => {
                        const percent = (slice.value || 0) / total;
                        const start = cumulativePercent;
                        const end = start + percent;
                        cumulativePercent = end;
                        
                        const [sx, sy] = [Math.cos(2*Math.PI*start), Math.sin(2*Math.PI*start)];
                        const [ex, ey] = [Math.cos(2*Math.PI*end), Math.sin(2*Math.PI*end)];
                        const large = percent > 0.5 ? 1 : 0;
                        const d = `M ${sx} ${sy} A 1 1 0 ${large} 1 ${ex} ${ey} L ${ex*0.65} ${ey*0.65} A 0.65 0.65 0 ${large} 0 ${sx*0.65} ${sy*0.65} Z`;
                        
                        return <path key={i} d={d} fill={slice.color} stroke="#18181b" strokeWidth="0.02" className="hover:opacity-80 transition-opacity"/>;
                    })}
                </svg>
            );
        });

        const ActionModal = ({ show, title, message, type, onConfirm, onClose }) => {
            if (!show) return null;

            const isConfirm = type === 'confirm';

            const handleClose = () => {
                onClose();
            };

            const handleConfirm = () => {
                onConfirm();
                onClose();
            };

            return (
                <div className="fixed inset-0 z-[9001] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4" onClick={handleClose}>
                    <div className="bg-[#18181b] border border-[#27272a] rounded-xl w-full max-w-sm shadow-2xl overflow-hidden animate-zoom-in" onClick={e=>e.stopPropagation()}>
                        <div className="p-4 border-b border-[#27272a] bg-[#0c0c0c] flex justify-between items-center">
                            <h3 className="font-bold text-yellow-500 flex items-center gap-2">
                                {isConfirm ? <Icon n="trash" c="w-5 h-5"/> : <Icon n="tag" c="w-5 h-5"/>} {title}
                            </h3>
                            <button onClick={handleClose} className="text-gray-500 hover:text-white transition"><Icon n="close" c="w-5 h-5"/></button>
                        </div>
                        <div className="p-6">
                            <p className="text-gray-300 leading-relaxed text-sm">{message}</p>
                        </div>
                        <div className="p-4 border-t border-[#27272a] flex justify-end gap-3">
                            {isConfirm && (
                                <button onClick={handleClose} className="px-4 py-2 text-gray-400 text-sm border border-[#3f3f46] rounded hover:bg-[#27272a] transition">取消</button>
                            )}
                            <button onClick={isConfirm ? handleConfirm : handleClose} className={`px-4 py-2 rounded text-sm transition ${isConfirm ? 'bg-rose-600 hover:bg-rose-700 text-white font-bold' : 'bg-yellow-600 hover:bg-yellow-700 text-black font-bold'}`}>
                                {isConfirm ? '確認' : '關閉'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };


        const Card = ({ item, spanClass, configLabels }) => {
            const isBig = spanClass.includes('row-span-2') || spanClass.includes('col-span-2');
            const isHuge = spanClass.includes('row-span-2') && spanClass.includes('col-span-2');

            const getDynamicFeatureLabel = (type) => {
                if (configLabels?.feature_label_map) {
                    const normalizedType = type.toLowerCase();
                    for (const [key, label] of Object.entries(configLabels.feature_label_map)) {
                        if (normalizedType.includes(key) || type.includes(key)) return label;
                    }
                }
                return "特點";
            };

            const searchUrl = (platform) => {
                const q = encodeURIComponent(`${item.brand} ${item.model}`);
                return platform === 'shopee' ? `https://shopee.tw/search?keyword=${q}` : `https://www.momoshop.com.tw/search/searchShop.jsp?keyword=${q}`;
            };

            const typo = {
                brand: isHuge ? "text-lg font-black tracking-[0.2em]" : "text-xs font-bold tracking-widest",
                title: isHuge ? "text-5xl md:text-6xl mt-2 mb-4" : (isBig ? "text-3xl mt-1 mb-2" : "text-xl"),
                verdict: isHuge ? "text-base" : (isBig ? "text-base" : "text-sm"),
                listText: isHuge ? "text-base" : "text-xs",
            };

            return (
                <div className={`bg-[#18181b] border border-[#27272a] rounded-xl p-5 flex flex-col gap-3 hover:border-yellow-600/50 hover:shadow-2xl transition-all duration-300 h-full group ${spanClass}`}>
                    <div className="flex justify-between items-start">
                        <div className="min-w-0 pr-2 flex-1">
                            <span className={`text-yellow-500 uppercase block truncate ${typo.brand}`}>{item.brand}</span>
                            <h3 className={`font-bold text-gray-100 leading-none truncate ${typo.title}`}>{item.model}</h3>
                            <div className="flex gap-2 mt-2">
                                <span className="flex items-center gap-1 bg-[#27272a] text-gray-400 px-2 py-1 rounded border border-[#3f3f46] text-xs"><Icon n="tag" c="w-3 h-3"/> {item.type}</span>
                                <span className="flex items-center gap-1 bg-[#27272a] text-gray-400 px-2 py-1 rounded border border-[#3f3f46] text-xs"><Icon n="scale" c="w-3 h-3"/> {item.capacity}</span>
                            </div>
                        </div>
                        <button onClick={() => window.open(`https://www.google.com/search?tbm=isch&q=${encodeURIComponent(item.brand + ' ' + item.model)}`, '_blank')} className="flex items-center gap-1 bg-[#27272a] hover:bg-[#3f3f46] text-gray-400 hover:text-white px-2 py-1.5 rounded border border-[#3f3f46] transition-colors flex-shrink-0" title="圖片搜尋">
                            <Icon n="image" c="w-4 h-4"/><span className={isBig ? "text-xs ml-1" : "hidden"}>圖</span>
                        </button>
                    </div>

                    <div className="bg-[#27272a]/50 p-3 rounded border-l-4 border-yellow-600 flex flex-col gap-1">
                        <div className="flex justify-between items-center text-xs font-bold tracking-wider text-gray-500 mb-1">
                            <span>VERDICT</span>
                            <span className="text-yellow-500 font-mono text-base">{item.priceLevel}</span>
                        </div>
                        <p className={`text-gray-300 italic leading-relaxed ${typo.verdict}`}>"{item.verdict}"</p>
                    </div>

                    <div className={`grid grid-cols-2 gap-4 flex-grow ${isBig ? 'overflow-auto' : 'overflow-hidden'}`}>
                        {[ 
                            { color: "text-emerald-500", icon: "up", label: "優點", list: item.pros },
                            { color: "text-rose-500", icon: "down", label: "缺點", list: item.cons }
                        ].map((grp, idx) => (
                            <div key={idx}>
                                <span className={`${grp.color} font-bold block tracking-wide flex items-center gap-1 mb-1 ${typo.listText}`}><Icon n={grp.icon} c="w-3 h-3"/> {grp.label}</span>
                                <ul className={`space-y-1 text-gray-400 ${typo.listText}`}>
                                    {grp.list.slice(0, isHuge ? 8 : 3).map((t,i)=><li key={i} className="truncate flex items-center"><span className={`mr-1.5 ${grp.color}/50`}>•</span>{t}</li>)}
                                </ul>
                            </div>
                        ))}
                    </div>

                    <div className="flex items-center justify-between border-t border-[#27272a] pt-3 mt-auto">
                        <div className={`${isHuge ? 'w-16 h-16' : 'w-12 h-12'} relative flex-shrink-0 mr-4`}><PieChart data={item.sentiment} /></div>
                        <div className="flex flex-col items-end">
                            <span className={`text-gray-500 uppercase font-bold ${isHuge ? "text-sm" : "text-xs"}`}>{getDynamicFeatureLabel(item.type)}</span>
                            <span className={`text-gray-200 font-mono border border-[#3f3f46] bg-[#27272a] px-2 py-0.5 rounded ${isHuge ? "text-lg" : "text-sm"}`}>{item.feature || "N/A"}</span>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-2 mt-2 text-xs font-bold text-white">
                        <a href={searchUrl('shopee')} target="_blank" className="bg-[#ee4d2d] py-2 rounded hover:opacity-90 transition flex justify-center items-center gap-1">Shopee</a>
                        <a href={searchUrl('momo')} target="_blank" className="bg-[#d63086] py-2 rounded hover:opacity-90 transition flex justify-center items-center gap-1">MOMO</a>
                    </div>
                </div>
            );
        };

        const CloudImportModal = ({ show, onClose, onImport, showAlert }) => {
            const [url, setUrl] = useState("");
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState("");

            if (!show) return null;

            const handleRun = async () => {
                if (!url.trim()) return setError("請輸入網址");
                setLoading(true); setError("");
                try {
                    const res = await fetch(Utils.proxyUrl(url.trim()));
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const json = Utils.parseJSON(await res.text());
                    if (!Array.isArray(json) || !json.length) throw new Error("無效資料或格式錯誤");
                    onImport(json);
                    showAlert(`成功匯入 ${json.length} 筆資料。`, "匯入成功");
                    onClose();
                } catch (e) { 
                    setError(`匯入失敗: ${e.message}`); 
                } finally { setLoading(false); }
            };

            return (
                <div className="fixed inset-0 z-[9000] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4" onClick={loading ? null : onClose}>
                    <div className="bg-[#18181b] border border-[#27272a] rounded-xl w-full max-w-md shadow-2xl overflow-hidden animate-zoom-in" onClick={e=>e.stopPropagation()}>
                        <div className="p-4 border-b border-[#27272a] bg-[#0c0c0c] flex justify-between items-center"><h3 className="font-bold text-yellow-500 flex items-center gap-2"><Icon n="cloud"/> 雲端匯入</h3></div>
                        <div className="p-6">
                            <p className="text-gray-400 text-sm mb-4">貼上一個包含咖啡器材資料的 JSON 檔案 URL (如 Google Drive 分享連結)。</p>
                            <input value={url} onChange={e=>setUrl(e.target.value)} placeholder="貼上 JSON URL..." className="w-full bg-black border border-[#3f3f46] rounded p-3 text-white text-sm focus:border-blue-500 focus:outline-none" disabled={loading}/>
                            {error && <p className="text-rose-400 text-sm mt-2">{error}</p>}
                        </div>
                        <div className="p-4 border-t border-[#27272a] flex justify-end gap-2">
                            <button onClick={onClose} disabled={loading} className="px-4 py-2 text-gray-400 text-sm border border-[#3f3f46] rounded hover:bg-[#27272a] transition-colors">取消</button>
                            <button onClick={handleRun} disabled={loading} className="px-4 py-2 bg-blue-600 text-white rounded text-sm flex items-center justify-center gap-2 hover:bg-blue-700 transition-colors">
                                {loading && <Icon n="refresh" c="spin w-4 h-4"/>} 匯入資料
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [db, setDb] = useState([]);
            const [config, setConfig] = useState(null);
            const [loading, setLoading] = useState(true);
            const [modalOpen, setModalOpen] = useState(false);
            const [actionModal, setActionModal] = useState({ show: false, title: '', message: '', type: 'alert', onConfirm: () => {} });
            
            const [selectedBrand, setSelectedBrand] = useState('所有品牌');
            const [selectedType, setSelectedType] = useState('所有類型');
            
            const showAlert = useCallback((message, title = '訊息') => {
                setActionModal({ show: true, title, message, type: 'alert', onConfirm: () => {} });
            }, []);

            const showConfirm = useCallback((message, title = '確認操作', onConfirm) => {
                setActionModal({ show: true, title, message, type: 'confirm', onConfirm });
            }, []);

            const handleImport = useCallback((newData) => {
                setDb(prev => {
                    const existingIds = new Set(prev.map(i => i.id));
                    const imported = newData.map(Utils.enrich).filter(x=>x);
                    const unique = imported.map(i => ({ 
                        ...i, 
                        // If ID exists, generate a new one to prevent conflicts
                        id: existingIds.has(i.id) ? Utils.genId() : i.id 
                    }));
                    return [...unique, ...prev];
                });
            }, []);

            const handleFile = async (e) => {
                const files = Array.from(e.target.files);
                if (!files.length) return;
                
                try {
                    const contents = await Promise.all(files.map(f => new Promise(res => {
                        const r = new FileReader();
                        r.onload = ev => res(Utils.parseJSON(ev.target.result));
                        r.readAsText(f);
                    })));
                    
                    const flat = contents.flat().filter(x => x);
                    
                    if (flat.length) {
                        handleImport(flat);
                        showAlert(`成功匯入 ${flat.length} 筆資料。`, "匯入成功");
                    } else {
                        showAlert("未找到有效的 JSON 資料。", "匯入失敗");
                    }
                } catch (error) {
                    showAlert(`讀取檔案時發生錯誤: ${error.message}`, "錯誤");
                }
                
                e.target.value = null;
            };

            const handleResetDb = () => {
                showConfirm(
                    "確定要重設整個資料庫嗎？此操作將清除所有本地儲存的咖啡器材資料！",
                    "確認重設資料庫",
                    () => {
                        Utils.delLS(CONSTANTS.LS_KEY); 
                        window.location.reload();
                    }
                );
            };
            
            const handleDebug = () => {
                console.groupCollapsed(`%c[CGF DEBUG] Filter State and Data (%d items)`, 'color: #f59e0b; font-weight: bold;', db.length);
                console.log("%cDB Content (First 5 Items):", 'color: #38bdf8; font-weight: bold;', db.slice(0, 5));
                
                // Log filter states with their raw value and trimmed length for inspection
                console.log("%cSelected Brand:", 'color: #a78bfa; font-weight: bold;', {
                    value: selectedBrand,
                    trimmedValue: selectedBrand.trim(),
                    rawValueLength: selectedBrand.length,
                    trimmedLength: selectedBrand.trim().length,
                });
                console.log("%cSelected Type:", 'color: #a78bfa; font-weight: bold;', {
                    value: selectedType,
                    trimmedValue: selectedType.trim(),
                    rawValueLength: selectedType.length,
                    trimmedLength: selectedType.trim().length,
                });

                // Log unique lists with their raw length for verification
                console.log("%cUnique Brands (Verify lengths):", 'color: #10b981; font-weight: bold;', uniqueBrands.map(b => ({ brand: b, length: b.length })));
                console.log("%cUnique Types (Verify lengths):", 'color: #10b981; font-weight: bold;', uniqueTypes.map(t => ({ type: t, length: t.length })));
                
                // Log failed items for current filter combination
                if (selectedBrand !== '所有品牌' || selectedType !== '所有類型') {
                    const failedItems = db.filter(item => {
                        const brandMatch = selectedBrand === '所有品牌' || item.brand.trim() === selectedBrand.trim();
                        const typeMatch = selectedType === '所有類型' || item.type.trim() === selectedType.trim();
                        return !(brandMatch && typeMatch);
                    }).slice(0, 5);
                    console.log(`%cItems NOT matching the current filter (First 5):`, 'color: #ef4444; font-weight: bold;', failedItems.map(item => ({
                        model: item.model,
                        dbBrand: item.brand, 
                        dbType: item.type,
                        brandMatch: selectedBrand === '所有品牌' || item.brand.trim() === selectedBrand.trim(),
                        typeMatch: selectedType === '所有類型' || item.type.trim() === selectedType.trim(),
                    })));
                }

                console.groupEnd();
                showAlert("已將除錯資訊（資料庫、唯一值、選定狀態與長度）輸出到瀏覽器控制台 (Console)。請按 F12 打開開發者工具查看。", "除錯資訊輸出");
            };


            // 計算不重複的品牌和類型 (確保選項值是乾淨的)
            const uniqueBrands = useMemo(() => {
                // 修正：明確對每個品牌進行 trim，確保 Set 中的鍵是乾淨的
                const brands = new Set(db.map(item => item.brand.trim()).filter(Boolean));
                return ['所有品牌', ...Array.from(brands).sort()];
            }, [db]);

            const uniqueTypes = useMemo(() => {
                // 修正：明確對每個類型進行 trim，確保 Set 中的鍵是乾淨的
                const types = new Set(db.map(item => item.type.trim()).filter(Boolean));
                return ['所有類型', ...Array.from(types).sort()];
            }, [db]);

            // 根據篩選條件過濾資料 - 採用最防禦性的比較
            const currentData = useMemo(() => {
                if (!db.length) return [];
                return db.filter(item => {
                    // 修正：在比較時，同時對資料項目的屬性與選定的狀態值執行 .trim()
                    const brandMatch = selectedBrand === '所有品牌' || item.brand.trim() === selectedBrand.trim();
                    const typeMatch = selectedType === '所有類型' || item.type.trim() === selectedType.trim();
                    
                    // 1+1 (AND) 邏輯：只有當兩個條件都滿足時才顯示 (或其中一個是'所有')
                    return brandMatch && typeMatch;
                });
            }, [db, selectedBrand, selectedType]);

            useEffect(() => {
                const init = async () => {
                    setLoading(true);
                    let initialData = [];
                    const local = Utils.getLS(CONSTANTS.LS_KEY);
                    if (local) {
                        try {
                            // 確保舊的本地資料也會經過 Utils.enrich 淨化
                            const parsed = Utils.parseJSON(local);
                            if (parsed && parsed.length) {
                                initialData = parsed.map(Utils.enrich).filter(x=>x);
                                setDb(initialData);
                            }
                        } catch { Utils.delLS(CONSTANTS.LS_KEY); }
                    }

                    let cfg = {};
                    try {
                        const cfgRes = await fetch(CONSTANTS.CONFIG_FILE);
                        cfg = cfgRes.ok ? await cfgRes.json() : {};
                        setConfig(cfg);
                    } catch (e) {
                        console.warn("Config load failed:", e);
                    }

                    if (initialData.length === 0) {
                        try {
                            const manifestPath = cfg?.db_config?.manifest_file || CONSTANTS.DEFAULT_MANIFEST;
                            const manifestRes = await fetch(manifestPath);
                            if (!manifestRes.ok) throw new Error("Manifest Not Found");
                            const manifest = await manifestRes.json();

                            const results = await Promise.allSettled((manifest.files || []).map(f => fetch(f).then(r => r.json())));
                            
                            const mergedData = results
                                .filter(r => r.status === 'fulfilled')
                                .map(r => r.value)
                                .flat()
                                .map(Utils.enrich)
                                .filter(x => x);

                            if (mergedData.length) {
                                setDb(mergedData);
                                Utils.setLS(CONSTANTS.LS_KEY, JSON.stringify(mergedData));
                            }
                        } catch (e) {
                            console.warn("Manifest/File load failed:", e);
                        }
                    } 
                    
                    setLoading(false);
                };
                init();
            }, [showAlert]); 

            useEffect(() => { 
                // Save data to localStorage whenever db changes (unless it's empty during initial load)
                if (db.length) Utils.setLS(CONSTANTS.LS_KEY, JSON.stringify(db)); 
            }, [db]);

            const currentVersion = config?.project?.version || "v47";
            const headerTitle = config?.ui_labels?.header_title || "COFFEE GEEK";

            if (loading && !db.length) return <div className="min-h-screen bg-[#0c0c0c] flex items-center justify-center"><div className="w-12 h-12 border-4 border-yellow-600 rounded-full spin border-t-transparent"></div></div>;

            const mainUI = (
                <div className="min-h-screen bg-[#0c0c0c] pb-20 fade-in">
                    <nav className="sticky top-0 z-40 bg-[#0c0c0c]/90 backdrop-blur border-b border-[#27272a] px-4 py-3 shadow-lg">
                        <div className="max-w-[1600px] mx-auto flex items-center justify-between">
                            <div className="flex items-center gap-2 flex-shrink-0">
                                <span className="bg-yellow-500 text-black px-2 py-0.5 rounded font-black text-xs">{currentVersion}</span>
                                <h1 className="font-bold text-gray-100 tracking-tight text-lg">{headerTitle}</h1>
                            </div>
                            <div className="text-gray-500 text-sm font-mono">
                                總覽模式 (Total: {db.length} 項)
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-[1600px] mx-auto p-4">
                        {/* 篩選器和項目總覽 */}
                        <div className="flex justify-between items-center mb-4 px-1 text-sm font-mono text-gray-400">
                            {/* 顯示當前篩選狀態 */}
                            <p>顯示項目: <span className="text-yellow-500">{currentData.length}</span> / 總計: {db.length} (篩選: <span className="text-yellow-500">{selectedBrand}</span>, <span className="text-yellow-500">{selectedType}</span>)</p>
                            <div className="flex gap-4">
                                {/* 品牌篩選器 */}
                                <select
                                    value={selectedBrand}
                                    onChange={(e) => setSelectedBrand(e.target.value.trim())}
                                    className="bg-[#18181b] border border-[#3f3f46] rounded px-3 py-1 text-sm text-gray-200 focus:ring-yellow-500 focus:border-yellow-500 cursor-pointer"
                                >
                                    {uniqueBrands.map(brand => (
                                        <option key={brand} value={brand}>{brand}</option>
                                    ))}
                                </select>
                                {/* 類型篩選器 */}
                                <select
                                    value={selectedType}
                                    onChange={(e) => setSelectedType(e.target.value.trim())}
                                    className="bg-[#18181b] border border-[#3f3f46] rounded px-3 py-1 text-sm text-gray-200 focus:ring-yellow-500 focus:border-yellow-500 cursor-pointer"
                                >
                                    {uniqueTypes.map(type => (
                                        <option key={type} value={type}>{type}</option>
                                    ))}
                                </select>
                            </div>
                        </div>
                        {/* 篩選器結束 */}


                        {currentData.length > 0 ? (
                            <div className="tetris-grid">
                                {currentData.map(item => <Card key={item.id} item={item} spanClass={Utils.getSpanClass(item)} configLabels={config?.ui_labels} />)}
                            </div>
                        ) : (
                            <div className="flex flex-col items-center justify-center py-20 text-gray-600 border-2 border-dashed border-[#27272a] rounded-xl">
                                <Icon n="search" c="w-12 h-12 mb-4 opacity-20"/>
                                <p className="text-lg font-bold text-gray-500 mb-4">目前篩選條件下無項目</p>
                                <p className="text-sm text-gray-500 mb-6">請調整您的品牌或類型篩選條件。</p>
                            </div>
                        )}
                    </main>

                    <footer className="fixed bottom-0 left-0 w-full bg-[#0c0c0c] border-t border-[#27272a] py-3 px-6 z-30 flex justify-between items-center text-sm text-gray-500">
                        <div className="flex gap-4">
                            <button onClick={handleResetDb} className="hover:text-red-500 flex items-center gap-1 transition-colors"><Icon n="trash"/> 重設資料庫</button>
                            <button onClick={()=>setModalOpen(true)} className="hover:text-blue-500 flex items-center gap-1 transition-colors"><Icon n="cloud"/> 雲端匯入</button>
                        </div>
                        <div className="flex gap-4">
                             <button onClick={handleDebug} className="hover:text-amber-500 flex items-center gap-1 transition-colors"><Icon n="search"/> 除錯輸出</button>
                            <button onClick={() => {
                                const a = document.createElement('a');
                                a.href = URL.createObjectURL(new Blob([JSON.stringify(db, null, 2)], {type: "application/json"}));
                                a.download = `backup_${new Date().toISOString().slice(0,10)}.json`;
                                a.click();
                            }} className="hover:text-blue-400 flex items-center gap-1 transition-colors"><Icon n="download"/> 備份資料</button>
                            <label className="hover:text-green-400 flex items-center gap-1 cursor-pointer transition-colors"><Icon n="upload"/> 檔案匯入<input type="file" multiple accept=".json" className="hidden" onChange={handleFile}/></label>
                        </div>
                    </footer>
                </div>
            );


            const emptyState = (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-[#0c0c0c] text-center fade-in">
                    <div className="mb-10 text-white">
                        <div className="w-24 h-24 bg-gradient-to-br from-yellow-600 to-yellow-800 rounded-full flex items-center justify-center mx-auto border-4 border-[#27272a] shadow-2xl mb-4"><Icon n="chef" c="w-12 h-12"/></div>
                        <h1 className="text-5xl font-black">{headerTitle}</h1>
                        <p className="text-gray-400 tracking-[0.3em] text-xs uppercase mt-2">資料庫是空的，請匯入資料</p>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-3xl">
                        <label className="cursor-pointer bg-[#18181b] border border-[#27272a] p-8 rounded-2xl hover:border-yellow-600/50 flex flex-col items-center gap-4 shadow-lg transition">
                            <Icon n="upload" c="w-8 h-8 text-yellow-500"/>
                            <div><h3 className="font-bold text-white">本地匯入 JSON</h3></div>
                            <input type="file" multiple accept=".json" className="hidden" onChange={handleFile}/>
                        </label>
                        <button onClick={()=>setModalOpen(true)} className="bg-[#18181b] border border-[#27272a] p-8 rounded-2xl hover:border-blue-600/50 flex flex-col items-center gap-4 shadow-lg transition">
                            <Icon n="cloud" c="w-8 h-8 text-blue-500"/>
                            <div><h3 className="font-bold text-white">雲端匯入 URL</h3></div>
                        </button>
                    </div>
                    <div className="text-xs text-gray-600 font-mono pt-10">版本: {currentVersion} | 總計: 0 項</div>
                </div>
            );

            // Conditional rendering now returns fragments containing both UI and modals.
            if (!db.length && !loading) return (
                <>
                    {emptyState}
                    <CloudImportModal show={modalOpen} onClose={()=>setModalOpen(false)} onImport={handleImport} showAlert={showAlert}/>
                    <ActionModal {...actionModal} onClose={() => setActionModal(p => ({...p, show: false}))} />
                </>
            );

            // Main display returns UI and Modals as siblings to maximize visibility
            return (
                <>
                    {mainUI}
                    <CloudImportModal show={modalOpen} onClose={()=>setModalOpen(false)} onImport={handleImport} showAlert={showAlert}/>
                    <ActionModal {...actionModal} onClose={() => setActionModal(p => ({...p, show: false}))} />
                </>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>