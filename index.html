<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coffee Geek Finder v41 | Final Stable</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        body { background-color: #0c0c0c; color: #e5e5e5; font-family: system-ui, -apple-system, sans-serif; overflow-x: hidden; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0c0c0c; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .tetris-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            grid-auto-rows: auto; 
            grid-auto-flow: dense; 
            gap: 1.5rem; 
        }

        /* Markdown Styles */
        .mkd h1, .mkd h2, .mkd h3 { color: #facc15; font-weight: 700; margin-top: 1em; margin-bottom: 0.5em; border-bottom: 1px solid #333; padding-bottom: 0.3em; }
        .mkd ul { list-style: disc; padding-left: 1.5em; color: #a8a29e; margin-bottom: 1em; }
        .mkd li { margin-bottom: 0.2em; }
        .mkd strong { color: #fff; font-weight: 600; }
        .mkd p { margin-bottom: 0.8em; line-height: 1.6; }
        .mkd table { border-collapse: collapse; width: 100%; margin: 1em 0; font-size: 0.9em; }
        .mkd th, .mkd td { border: 1px solid #444; padding: 0.5em; text-align: left; }
        .mkd th { background-color: #222; color: #facc15; }

        /* 確保 modal-root 節點自身擁有最高層級和固定定位，交由 React 動態控制 pointer-events */
        #modal-root {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999; 
        }
    </style>
</head>
<body>
    <!-- 主應用程式的根節點 -->
    <div id="root"></div>
    <!-- 獨立 Modal 專用的根節點，與主應用程式隔離 -->
    <div id="modal-root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;

        // --- 1. Configuration ---
        const CFG = {
            LS_KEY: "CGF_DB_V41_FINAL",
            API_MODEL: "gemini-2.5-flash-preview-09-2025",
            MANIFEST_FILE: "./db_manifest.json" 
        };

        // --- 2. Global Event Bus (for Modal communication) ---
        const eventBus = {
            listeners: {},
            on(event, callback) {
                if (!this.listeners[event]) this.listeners[event] = [];
                this.listeners[event].push(callback);
            },
            emit(event, data) {
                if (this.listeners[event]) {
                    this.listeners[event].forEach(callback => callback(data));
                }
            }
        };

        // --- 3. Logic Layer ---
        const IO = {
            get: (k) => { try { return localStorage.getItem(k); } catch { return null; } },
            set: (k, v) => { try { localStorage.setItem(k, v); return true; } catch { return false; } },
            del: (k) => { try { localStorage.removeItem(k); } catch {} },
            
            genId: (list) => {
                if (!Array.isArray(list)) return Date.now();
                return list.reduce((max, item) => Math.max(max, Number(item.id) || 0), 0) + 1;
            },

            enrich: (raw) => {
                if (!raw || typeof raw !== 'object') return null;
                const p = { ...raw };
                p.id = p.id || Date.now() + Math.random();
                p.brand = String(p.brand || "Unknown");
                p.model = String(p.model || "Unknown Model");
                p.type = String(p.type || "Equipment");
                p.priceLevel = String(p.priceLevel || "$");
                p.capacity = String(p.capacity || "N/A");
                p.feature = String(p.feature || "");
                p.pros = Array.isArray(p.pros) ? p.pros : [];
                p.cons = Array.isArray(p.cons) ? p.cons : [];
                p.sentiment = Array.isArray(p.sentiment) ? p.sentiment : [{ name: "N/A", value: 100, color: "#555" }];
                p.verdict = p.verdict || "No verdict available.";
                return p;
            },

            parseJSON: (text) => {
                if (!text) return null;
                try {
                    const clean = text.replace(/```json|```/g, '').trim();
                    const start = clean.indexOf('[');
                    const end = clean.lastIndexOf(']');
                    if (start !== -1 && end !== -1) {
                        return JSON.parse(clean.substring(start, end + 1));
                    }
                    return JSON.parse(clean);
                } catch (e) {
                    return null;
                }
            },

            getSpanClass: (item) => {
                let score = 0;
                const pros = item.pros || [];
                const cons = item.cons || [];
                const len = (item.verdict || "").length;
                if (pros.length + cons.length >= 5) score += 2;
                if (item.priceLevel === "$$$$$") score += 2;
                else if (item.priceLevel === "$$$$") score += 1;
                if (len > 25) score += 1;
                const hash = (parseInt(item.id) || 0) % 3;
                if (score >= 4) return "col-span-1 md:col-span-2 row-span-2"; 
                if (score === 3) return hash === 0 ? "col-span-1 md:col-span-2 row-span-1" : "col-span-1 row-span-2";
                return "col-span-1 row-span-1";
            },

            getFeatureLabel: (type) => {
                const t = (type || "").toLowerCase();
                if(t.includes("磨") || t.includes("grinder")) return "刀盤";
                if(t.includes("濾") || t.includes("壺") || t.includes("filter")) return "結構";
                if(t.includes("秤") || t.includes("scale")) return "特性";
                if(t.includes("壓") || t.includes("press")) return "機制";
                return "特點";
            },

            proxyUrl: (url) => {
                const driveRegex = /\/file\/d\/([a-zA-Z0-9_-]+)\//;
                const match = url.match(driveRegex);
                if (match && match[1]) {
                    return `https://api.allorigins.win/raw?url=${encodeURIComponent(`https://drive.google.com/uc?export=download&id=${match[1]}`)}`;
                }
                return url;
            }
        };

        // --- 4. Icons ---
        const Icon = ({ n, c = "w-4 h-4" }) => {
            const paths = {
                search: "m21 21-4.3-4.3M11 19a8 8 0 1 0 0-16 8 8 0 0 0 0 16z",
                cloud: "M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242",
                upload: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12",
                settings: "M12.22 2h-.44a2 2 0 0 1-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l-.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z M12 9a3 3 0 1 0 0 6 3 3 0 0 0 0-6z",
                plus: "M12 5v14M5 12h14",
                trash: "M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",
                download: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3",
                msg: "M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z",
                chef: "M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 9.08 0A5.11 5.11 0 0 1 18.59 6 4 4 0 0 1 20 13.87V21H6Z M6 17h14",
                scale: "M6 20h12a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2z M12 14v4 M12 2v4",
                tag: "M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z M7 7h.01",
                image: "M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z M12 17a4 4 0 1 0 0-8 4 4 0 0 0 0 8z",
                up: "M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3",
                down: "M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2h-3",
                refresh: "M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16",
                close: "M18 6 6 18 M6 6 18 18"
            };
            return <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={c}><path d={paths[n] || ""}/></svg>;
        };

        // --- 5. Shared Modal Component (Global Root) ---
        // 修正點：GlobalModal 現在負責渲染所有子 Modal (API Key, Cloud Import, Search Result)
        const GlobalModal = ({ onImport, onKeySave, initialKey, onAddSearchItem }) => {
            const [modal, setModal] = useState({ open: false, title: "", content: "", loading: false, type: "", iconName: "msg", results: null, apiKey: initialKey });
            
            useEffect(() => {
                const listener = (data) => setModal(prev => {
                    if (data.open === false) {
                        return { open: false, title: "", content: "", loading: false, type: "", iconName: "msg", results: null, apiKey: prev.apiKey };
                    }
                    return {...prev, ...data, apiKey: data.apiKey !== undefined ? data.apiKey : prev.apiKey};
                });
                eventBus.on('SHOW_MODAL', listener);
                return () => eventBus.listeners['SHOW_MODAL'] = eventBus.listeners['SHOW_MODAL'].filter(l => l !== listener);
            }, []);
            
            // 修正點 2: 處理 modal-root 的點擊事件
            useEffect(() => {
                setModal(prev => ({...prev, apiKey: initialKey}));
                const modalRootEl = document.getElementById('modal-root');
                if (modalRootEl) {
                    // 只有當 modal.open 為 true 時，才讓 modal-root 捕獲點擊事件，否則讓事件穿透
                    modalRootEl.style.pointerEvents = modal.open ? 'auto' : 'none';
                }
            }, [modal.open, initialKey]);

            if (!modal.open) return null;

            const handleClose = () => eventBus.emit('SHOW_MODAL', { open: false });
            
            let ModalContentComponent = null;
            let containerClass = "w-full max-w-2xl min-h-[12rem] max-h-[80vh] flex flex-col overflow-hidden";
            let titleIcon = modal.iconName || "msg";
            let titleColor = modal.iconName === 'close' ? 'text-red-500' : 'text-yellow-500';

            switch (modal.type) {
                case 'key-settings':
                    containerClass = "w-full max-w-sm";
                    titleIcon = "settings";
                    ModalContentComponent = <ApiKeyModal key={modal.apiKey} onClose={handleClose} onSave={onKeySave} initialKey={modal.apiKey} />;
                    break;
                case 'cloud-import':
                    containerClass = "w-full max-w-md";
                    titleIcon = "cloud";
                    titleColor = 'text-blue-500';
                    ModalContentComponent = <CloudImportModal onClose={handleClose} onImport={onImport} />;
                    break;
                case 'search-results':
                    containerClass = "w-full max-w-4xl max-h-[85vh] flex flex-col overflow-hidden";
                    titleIcon = "search";
                    ModalContentComponent = <SearchResultModal results={modal.results} onClose={handleClose} onAdd={onAddSearchItem} />;
                    break;
                case 'snark':
                case 'recipe':
                case 'success':
                case 'error':
                default:
                    // AI Response or simple message modal
                    const currentIcon = modal.loading ? "refresh" : (modal.iconName || "msg");
                    const iconColor = modal.iconName === 'close' ? 'text-red-500' : 'text-yellow-500';
                    titleIcon = currentIcon;
                    titleColor = iconColor;
                    ModalContentComponent = (
                        <div className="flex flex-col flex-grow">
                            <div className="p-6 overflow-y-auto text-gray-300 mkd flex-grow">
                                {modal.loading ? (
                                    <div className="flex flex-col items-center py-10">
                                        <div className="w-10 h-10 border-2 border-yellow-600 border-t-transparent rounded-full spin"></div>
                                        <p className="mt-4 text-sm text-yellow-500">AI 正在努力思考中...</p>
                                    </div>
                                ) : (
                                    <div dangerouslySetInnerHTML={{__html: marked.parse(modal.content||"")}} />
                                )}
                            </div>
                        </div>
                    );
            }
            
            // 修正點 3: 渲染 Modal Wrapper (統一的 Z-Index)
            return (
                <div className="fixed inset-0 z-[9100] flex items-center justify-center bg-black/80 p-4" onClick={()=>!modal.loading && handleClose()}>
                    <div className={`bg-[#18181b] border border-[#27272a] rounded-xl shadow-2xl ${containerClass}`} onClick={e=>e.stopPropagation()}>
                        <div className="p-4 border-b border-[#27272a] bg-[#0c0c0c] flex justify-between items-center shrink-0">
                            <h3 className={`font-bold ${titleColor} flex items-center gap-2`}>
                                <Icon n={titleIcon} c={`w-5 h-5 ${modal.loading && modal.type !== 'search-results' ?"spin":""}`}/> {modal.title}
                            </h3>
                            <button onClick={handleClose} className="text-gray-500 hover:text-white text-xl"><Icon n="close" c="w-5 h-5"/></button>
                        </div>
                        {ModalContentComponent}
                    </div>
                </div>
            );
        };

        // --- Local Modal Content Components (No Z-Index or fixed/inset-0 needed here) ---

        const SearchResultModal = ({ results, onClose, onAdd }) => {
            return (
                <div className="flex flex-col flex-grow">
                    <div className="p-6 overflow-y-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 bg-[#0c0c0c] flex-grow">
                        {results.map(item => (
                            <div key={item.id} className="bg-[#1f1f22] border border-[#27272a] rounded-lg p-4 flex flex-col gap-2 hover:border-yellow-600/50">
                                <div className="flex justify-between">
                                    <span className="text-xs text-yellow-500 font-bold">{item.brand}</span>
                                    <span className="text-xs text-gray-400">{item.type}</span>
                                </div>
                                <h4 className="text-base font-bold text-white">{item.model}</h4>
                                <p className="text-sm text-gray-400 italic line-clamp-2">"{item.verdict}"</p>
                                <button 
                                    onClick={() => onAdd(item)}
                                    className="mt-auto w-full py-2 bg-emerald-900/30 text-emerald-400 border border-emerald-800 rounded hover:bg-emerald-900/50 text-sm flex items-center justify-center gap-2"
                                >
                                    <Icon n="plus" c="w-3 h-3"/> 加入資料庫
                                </button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const CloudImportModal = ({ onClose, onImport }) => {
            const [url, setUrl] = useState("");
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState("");

            const handleImport = async () => {
                if (!url.trim()) return;
                setLoading(true);
                setError("");
                const fetchUrl = IO.proxyUrl(url.trim());
                try {
                    const res = await fetch(fetchUrl);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const json = await res.json();
                    const data = Array.isArray(json) ? json : [json];
                    if (data.length === 0) throw new Error("Empty JSON");
                    onImport(data);
                    eventBus.emit('SHOW_MODAL', { open: true, title: "匯入成功", content: `成功匯入 ${data.length} 個項目。`, loading: false, type: "success", iconName: "msg" });
                } catch (err) {
                    setError("匯入失敗。請檢查網址與權限。");
                } finally { setLoading(false); }
            };

            return (
                <div className="p-6 flex flex-col">
                    <input type="text" value={url} onChange={e=>setUrl(e.target.value)} placeholder="貼上 JSON/TXT 檔案網址..." className="w-full bg-black border border-[#3f3f46] rounded p-3 text-white text-sm mb-2 focus:border-blue-500 focus:outline-none"/>
                    {error && <p className="text-red-400 text-sm mb-4">{error}</p>}
                    <div className="flex justify-end gap-2 mt-4">
                        <button onClick={onClose} className="px-4 py-2 text-gray-400 hover:text-white text-sm">取消</button>
                        <button onClick={handleImport} disabled={loading} className="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded text-sm transition flex items-center gap-2">
                            {loading && <Icon n="refresh" c="w-4 h-4 spin"/>} 匯入
                        </button>
                    </div>
                </div>
            );
        };

        const ApiKeyModal = ({ onClose, onSave, initialKey }) => {
            const [key, setKey] = useState(initialKey);
            return (
                <div className="p-6">
                    <input type="password" value={key} onChange={e=>setKey(e.target.value)} placeholder="貼上 Gemini Key" className="w-full bg-black border border-[#3f3f46] rounded p-3 text-white mb-4 focus:border-yellow-600 focus:outline-none"/>
                    <div className="flex justify-end">
                        <button onClick={()=>onSave(key)} className="px-4 py-2 bg-yellow-600 text-black font-bold rounded">儲存</button>
                    </div>
                </div>
            );
        };
        
        // --- 7. Main App ---
        const App = () => {
            const [db, setDb] = useState([]);
            const [loading, setLoading] = useState(true);
            const [query, setQuery] = useState("");
            const [filters, setFilters] = useState({ brand: "All", type: "All", capacity: "All" });
            
            // 修正點 4: 移除 keyModal, cloudModal, searchResults 的本地狀態
            const [apiKey, setApiKey] = useState("");

            useEffect(() => {
                const init = async () => {
                    const key = IO.get("GEMINI_KEY");
                    if(key) setApiKey(key);

                    const local = IO.get(CFG.LS_KEY);
                    let initialData = [];

                    if(local) {
                        try {
                            const parsed = JSON.parse(local);
                            if(Array.isArray(parsed) && parsed.length) {
                                initialData = parsed.map(IO.enrich).filter(x=>x);
                            }
                        } catch {}
                    }

                    // --- Manifest Load Logic (v40) ---
                    if (initialData.length === 0) {
                        try {
                            const manifestRes = await fetch(CFG.MANIFEST_FILE);
                            if (!manifestRes.ok) throw new Error("Manifest not found");
                            
                            const manifest = await manifestRes.json();
                            const filesToLoad = manifest.files || [];

                            const promises = filesToLoad.map(file => 
                                fetch(file).then(res => res.ok ? res.json() : [])
                            );
                            const results = await Promise.allSettled(promises);
                            const validData = results
                                .filter(r => r.status === 'fulfilled')
                                .map(r => r.value)
                                .flat()
                                .map(IO.enrich)
                                .filter(x => x);

                            if(validData.length > 0) {
                                initialData = validData;
                                IO.set(CFG.LS_KEY, JSON.stringify(validData));
                            }
                        } catch (e) {
                            console.warn("Manifest/Auto-load failed:", e.message);
                        }
                    }

                    setDb(initialData);
                    setLoading(false);
                };
                init();
            }, []);

            // Persist
            useEffect(() => {
                if(db.length > 0) IO.set(CFG.LS_KEY, JSON.stringify(db));
            }, [db]);

            // Filter
            const filteredData = useMemo(() => {
                let res = db;
                if (filters.brand !== "All") res = res.filter(i => i.brand === filters.brand);
                if (filters.type !== "All") res = res.filter(i => i.type === filters.type);
                if (filters.capacity !== "All") res = res.filter(i => i.capacity === filters.capacity);
                if (query.trim()) {
                    const q = query.toLowerCase();
                    res = res.filter(i => 
                        (i.brand || "").toLowerCase().includes(q) || 
                        (i.model || "").toLowerCase().includes(q) || 
                        (i.type || "").includes(q)
                    );
                }
                return res;
            }, [db, filters, query]);

            const options = useMemo(() => ({
                brand: ["All", ...new Set(db.map(i => i.brand))].sort(),
                type: ["All", ...new Set(db.map(i => i.type))].sort(),
                capacity: ["All", ...new Set(db.map(i => i.capacity))].sort()
            }), [db]);

            const handleImport = (newData) => {
                if(!newData || !Array.isArray(newData)) return;
                setDb(prev => {
                    const ids = new Set(prev.map(i => i.id));
                    const unique = newData.filter(i => !ids.has(i.id)).map(i => ({...IO.enrich(i), id: IO.genId(prev) + (Math.random() * 1000).toFixed(0)})).filter(x=>x);
                    if(unique.length === 0) {
                        eventBus.emit('SHOW_MODAL', { open: true, title: "匯入失敗", content: "沒有新的項目可以匯入。", loading: false, type: "error", iconName: "close" });
                        return prev;
                    }
                    return [...unique, ...prev];
                });
            };

            const handleFileImport = async (e) => {
                const files = Array.from(e.target.files);
                if(!files.length) return;
                
                const readPromises = files.map(file => new Promise(resolve => {
                    const r = new FileReader();
                    r.onload = evt => {
                        try { resolve(JSON.parse(evt.target.result)); } 
                        catch { resolve([]); }
                    };
                    r.readAsText(file);
                }));

                const rawResults = await Promise.all(readPromises);
                const flatItems = rawResults.flat().map(IO.enrich).filter(x=>x);
                
                if(flatItems.length > 0) {
                    handleImport(flatItems);
                    eventBus.emit('SHOW_MODAL', { open: true, title: "匯入成功", content: `成功匯入 ${flatItems.length} 個咖啡器具項目。`, loading: false, type: "success", iconName: "msg" });
                } else {
                    eventBus.emit('SHOW_MODAL', { open: true, title: "匯入失敗", content: "找不到有效的 JSON 資料。", loading: false, type: "error", iconName: "close" });
                }
                e.target.value = null;
            };
            
            // 修正點 5: 處理 API Key 儲存，並關閉 Modal
            const handleKeySave = (key) => {
                if (key && key.trim().length > 10) { 
                    IO.set("GEMINI_KEY", key);
                    setApiKey(key);
                    eventBus.emit('SHOW_MODAL', { open: false });
                } else {
                    eventBus.emit('SHOW_MODAL', { open: true, title: "錯誤", content: "無效的 API Key。", loading: false, type: "error", iconName: "close" });
                }
            };
            
            // 修正點 6: 統一 Modal 觸發邏輯 - 顯示 API Key 設定
            const showKeySettings = () => {
                 eventBus.emit('SHOW_MODAL', { open: true, title: "API Key 設定", content: "", loading: false, type: "key-settings", apiKey: apiKey });
            };

            // 修正點 7: 統一 Modal 觸發邏輯 - 顯示雲端匯入
            const showCloudImport = () => {
                eventBus.emit('SHOW_MODAL', { open: true, title: "雲端匯入", content: "", loading: false, type: "cloud-import" });
            };

            // Logic: Search Web
            const handleWebSearch = async (e) => {
                if (e) e.preventDefault();
                if(!query.trim()) return; 
                if(!apiKey) return showKeySettings();

                // --- CRITICAL: Immediate UI Update via setTimeout(0) ---
                setTimeout(async () => {
                    eventBus.emit('SHOW_MODAL', { open: true, title: `網頁搜尋: ${query}`, content: "", loading: true, type: "search" });
                    
                    const prompt = `Search coffee gear: "${query}". Return JSON ARRAY. Schema: {"brand":"String (TW)","model":"String (TW)","type":"String (TW)","material":"String (TW)","capacity":"String (TW)","feature":"String (TW)","priceLevel":"String ($$$)","verdict":"String (TW)","pros":["String (TW)"],"cons":["String (TW)"],"sentiment":[{"name":"Tag (TW)","value":Number,"color":"String (#hex)"}]}. Return ONLY JSON.`;
                    
                    try {
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${CFG.API_MODEL}:generateContent?key=${apiKey}`, {
                            method: 'POST', headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], tools: [{"google_search":{}}], systemInstruction: { parts: [{ text: "You are a coffee equipment data generator. You must return the data in the specified JSON schema using Traditional Chinese for all fields except priceLevel and color." }] } })
                        });
                        
                        if (!res.ok) {
                            const errData = await res.json();
                            throw new Error(errData.error?.message || `HTTP ${res.status}`);
                        }
                        
                        const data = await res.json();
                        const jsonStr = data.candidates?.[0]?.content?.parts?.[0]?.text;
                        const parsed = IO.parseJSON(jsonStr);
                        
                        if(!parsed || !Array.isArray(parsed)) throw new Error("AI 回傳了無效的 JSON 格式");

                        const newItems = parsed.map(IO.enrich).filter(x=>x);
                        
                        // 修正點 8: 顯示搜尋結果 Modal
                        eventBus.emit('SHOW_MODAL', { open: true, title: "網頁搜尋結果", loading: false, type: "search-results", results: newItems, iconName: "search" }); 
                        
                    } catch (err) { 
                        eventBus.emit('SHOW_MODAL', { open: true, title: "網頁搜尋失敗", content: `錯誤訊息: ${err.message}`, loading: false, iconName: "close", type: "error" }); 
                    }
                }, 0); 
            };

            // Add single item from search results
            const addItemFromSearch = (item) => {
                const newItem = { ...item, id: IO.genId(db) }; 
                handleImport([newItem]);
                
                // 修正點 9: 關閉 search-results modal
                eventBus.emit('SHOW_MODAL', { open: false });
            };

            const handleAI = (mode, item, extra) => {
                if(!apiKey) return showKeySettings();

                // --- CRITICAL: Immediate UI Update via setTimeout(0) ---
                setTimeout(async () => {
                    const initialTitle = mode === 'snark' ? `AI 毒舌評論: ${item.model}` : `AI 沖煮建議: ${item.model}`;
                    eventBus.emit('SHOW_MODAL', { open: true, title: initialTitle, content: "", loading: true, type: mode });
                    
                    let prompt = "";
                    let systemInstruction = "";

                    if(mode === 'snark') {
                        prompt = `請用繁體中文、幽默毒舌但專業的語氣評論 ${item.brand} ${item.model}。指出它的致命缺點，並告訴我它適合什麼樣的受害者(使用者)。`;
                        systemInstruction = "你是一位極度毒舌且專業的咖啡器材評論家，請使用 Markdown 格式，並且必須使用繁體中文。";
                    } else if (mode === 'recipe') {
                        prompt = `針對 ${item.brand} ${item.model}，提供一份適合「${extra}」烘焙豆的具體沖煮參數（粉水比、研磨度、水溫、注水手法）。`;
                        systemInstruction = "你是一位頂尖的咖啡師，請使用 Markdown 表格來呈現沖煮參數，所有文字必須是繁體中文。";
                    }
                    
                    try {
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${CFG.API_MODEL}:generateContent?key=${apiKey}`, {
                            method: 'POST', headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ 
                                contents: [{ parts: [{ text: prompt }] }],
                                systemInstruction: { parts: [{ text: systemInstruction }] }
                            })
                        });
                        
                        if (!res.ok) {
                            const errData = await res.json();
                            throw new Error(errData.error?.message || `HTTP ${res.status}`);
                        }
                        
                        const data = await res.json();
                        const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                        
                        if (!text) throw new Error("AI 回傳了空白內容");
                        
                        eventBus.emit('SHOW_MODAL', { open: true, title: initialTitle, content: text, loading: false, type: mode, iconName: "msg" });
                    } catch (err) { 
                        eventBus.emit('SHOW_MODAL', { open: true, title: "AI 呼叫失敗", content: `錯誤訊息: ${err.message}`, loading: false, type: "error", iconName: "close" });
                    }
                }, 0);
            };

            const handleReset = () => { if(window.confirm("確定要重置資料庫嗎？所有本地儲存的資料都將會遺失。")) { IO.del(CFG.LS_KEY); window.location.reload(); } };
            const handleExport = () => {
                const blob = new Blob([JSON.stringify(db, null, 2)], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `coffee_geek_backup.json`;
                a.click();
            };

            if(loading && db.length === 0) return <div className="min-h-screen bg-[#0c0c0c] flex items-center justify-center"><div className="w-12 h-12 border-4 border-yellow-600 rounded-full spin border-t-transparent"></div></div>;

            if (db.length === 0) {
                return (
                    // 修正點 10: 歡迎畫面點擊事件
                    <>
                        <WelcomeScreen onFileImport={handleFileImport} onCloudClick={showCloudImport} />
                        <GlobalModal onImport={handleImport} onKeySave={handleKeySave} initialKey={apiKey} onAddSearchItem={addItemFromSearch} />
                    </>
                );
            }

            return (
                <div className="min-h-screen bg-[#0c0c0c] pb-20 fade-in text-base">
                    <nav className="sticky top-0 z-40 bg-[#0c0c0c]/90 backdrop-blur border-b border-[#27272a] px-4 py-3 shadow-lg">
                        <div className="max-w-[1600px] mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
                            <div className="flex items-center gap-2 flex-shrink-0">
                                <span className="bg-yellow-500 text-black px-2 py-0.5 rounded font-black text-xs">V41</span>
                                <h1 className="font-bold text-gray-100 tracking-tight text-lg">COFFEE GEEK</h1>
                            </div>
                            <form onSubmit={handleWebSearch} className="relative w-full max-w-xl group flex gap-2">
                                <div className="relative flex-1">
                                    <div className="absolute left-3 top-2.5 text-gray-500"><Icon n="search" c="w-4 h-4"/></div>
                                    <input 
                                        type="text" 
                                        value={query} 
                                        onChange={e=>setQuery(e.target.value)} 
                                        placeholder="搜尋器具..." 
                                        className="w-full bg-[#18181b] border border-[#27272a] text-gray-200 rounded-lg pl-9 pr-4 py-2 focus:border-yellow-600 focus:outline-none transition-all" 
                                    />
                                </div>
                                <button type="submit" className="flex items-center justify-center p-2 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-lg transition" title="網頁搜尋"><Icon n="search" c="w-5 h-5"/></button>
                            </form>
                            <div className="flex items-center gap-2 w-full md:w-auto overflow-x-auto pb-1 md:pb-0">
                                <select className="bg-[#18181b] border border-[#27272a] text-gray-300 rounded px-2 py-2 cursor-pointer focus:outline-none text-sm" value={filters.brand} onChange={e=>setFilters({...filters, brand: e.target.value})}>{options.brand.map(o=><option key={o} value={o}>{o}</option>)}</select>
                                <select className="bg-[#18181b] border border-[#27272a] text-gray-300 rounded px-2 py-2 cursor-pointer focus:outline-none text-sm" value={filters.type} onChange={e=>setFilters({...filters, type: e.target.value})}>{options.type.map(o=><option key={o} value={o}>{o}</option>)}</select>
                                <button onClick={showKeySettings} className={`p-2 rounded border transition ${apiKey ? 'border-green-900 text-green-500 bg-green-900/10' : 'border-[#27272a] text-gray-400 bg-[#18181b] hover:text-white'}`}><Icon n="settings"/></button>
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-[1600px] mx-auto p-4">
                        <div className="flex justify-between items-end mb-4 px-1">
                            <p className="text-gray-500 text-xs font-mono">項目: <span className="text-yellow-500">{filteredData.length}</span></p>
                        </div>
                        
                        {filteredData.length > 0 ? (
                            <div className="tetris-grid">
                                {filteredData.map(item => <Card key={item.id} item={item} spanClass={IO.getSpanClass(item)} onAI={handleAI} />)}
                            </div>
                        ) : (
                            <div className="flex flex-col items-center justify-center py-20 text-gray-600 border-2 border-dashed border-[#27272a] rounded-xl">
                                <Icon n="cloud" c="w-12 h-12 mb-4 opacity-20"/>
                                <p className="text-lg font-bold text-gray-500 mb-4">找不到本地資料</p>
                                <button 
                                    onClick={handleWebSearch}
                                    className="px-6 py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-lg shadow-lg transition flex items-center gap-2"
                                >
                                    <Icon n="search" c="w-5 h-5"/> 網頁搜尋 "{query}"
                                </button>
                            </div>
                        )}
                    </main>

                    <footer className="fixed bottom-0 left-0 w-full bg-[#0c0c0c] border-t border-[#27272a] py-3 px-6 z-30 flex justify-between items-center text-base text-gray-500">
                        <div className="flex gap-3">
                            <button onClick={handleReset} className="hover:text-red-500 flex items-center gap-1 transition text-sm"><Icon n="trash"/> 重置</button>
                            <button onClick={showCloudImport} className="hover:text-blue-500 flex items-center gap-1 transition text-sm"><Icon n="cloud"/> 雲端</button>
                        </div>
                        <div className="flex items-center gap-3">
                            <button onClick={handleExport} className="hover:text-blue-400 flex items-center gap-1 transition text-sm"><Icon n="download"/> 備份</button>
                            <label className="hover:text-green-400 flex items-center gap-1 cursor-pointer transition text-sm"><Icon n="upload"/> 檔案<input type="file" multiple accept=".json" className="hidden" onChange={handleFileImport}/></label>
                        </div>
                    </footer>

                    {/* 修正點 11: 只在 App 元件結尾處渲染 GlobalModal 一次 */}
                    <GlobalModal onImport={handleImport} onKeySave={handleKeySave} initialKey={apiKey} onAddSearchItem={addItemFromSearch} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        
        // --- Global Modal Renderer (Separate React Root) ---
        // 修正點 12: 移除單獨的 modalRoot.render，避免重複渲染和 Prop 傳遞問題
        // const modalRoot = ReactDOM.createRoot(document.getElementById('modal-root'));
        // modalRoot.render(<GlobalModal />);

        // --- Welcome Screen Component (Defined earlier) ---
        const WelcomeScreen = ({ onFileImport, onCloudClick }) => (
            <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-[#0c0c0c] text-center space-y-10 fade-in">
                <div className="space-y-4">
                    <div className="w-24 h-24 bg-gradient-to-br from-yellow-600 to-yellow-800 rounded-full flex items-center justify-center mx-auto border-4 border-[#27272a] shadow-2xl">
                        <Icon n="chef" c="w-12 h-12 text-white"/>
                    </div>
                    <h1 className="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-500">COFFEE GEEK</h1>
                    <p className="text-gray-400 tracking-[0.3em] text-xs uppercase">咖啡器具資料庫管理器</p>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-3xl">
                    <label className="group cursor-pointer bg-[#18181b] border border-[#27272a] p-8 rounded-2xl hover:border-yellow-600/50 hover:bg-[#1f1f22] transition-all duration-300 flex flex-col items-center gap-4 shadow-lg">
                        <div className="p-4 bg-[#27272a] rounded-full group-hover:bg-yellow-900/20 transition-colors">
                            <Icon n="upload" c="w-8 h-8 text-yellow-500"/>
                        </div>
                        <div>
                            <h3 className="text-xl font-bold text-white mb-1">匯入本地 JSON 檔</h3>
                            <p className="text-xs text-gray-500">可選取多個檔案</p>
                        </div>
                        <input type="file" multiple accept=".json" className="hidden" onChange={onFileImport}/>
                    </label>
                    <button onClick={onCloudClick} className="group cursor-pointer bg-[#18181b] border border-[#27272a] p-8 rounded-2xl hover:border-blue-600/50 hover:bg-[#1f1f22] transition-all duration-300 flex flex-col items-center gap-4 shadow-lg">
                        <div className="p-4 bg-[#27272a] rounded-full group-hover:bg-blue-900/20 transition-colors">
                            <Icon n="cloud" c="w-8 h-8 text-blue-500"/>
                        </div>
                        <div>
                            <h3 className="text-xl font-bold text-white mb-1">從雲端匯入</h3>
                            <p className="text-xs text-gray-500">透過 URL 載入</p>
                        </div>
                    </button>
                </div>
                <div className="text-xs text-gray-600 font-mono pt-10">v41.0 | FINAL STABLE</div>
            </div>
        );
    </script>
</body>
</html>